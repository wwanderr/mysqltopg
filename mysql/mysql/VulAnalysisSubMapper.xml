<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.dbapp.extension.xdr.vulnerabilityAnalysis.mapper.VulAnalysisSubMapper">

    <insert id="insertOrUpdate" parameterType="com.dbapp.extension.xdr.vulnerabilityAnalysis.entity.VulAnalysisSub" useGeneratedKeys="true" keyColumn="id">
        INSERT INTO t_vul_analysis_sub (   end_time,  start_time,  alarm_result, alarm_status,  app_protocol,  clear_text,  request_url,  cve,
          severity_level,  vulnerability_name,  class_type,  src_user_name, passwd,  `Medium`,  High,  Low,  agg_count,  event_code, update_time,
         `source`, chart_id , asset_ip , asset_name , dest_security_zone , asset_type,asset_tags )
        VALUES
        (#{endTime,jdbcType=VARCHAR},#{startTime,jdbcType=VARCHAR},#{alarmResult,jdbcType=INTEGER},#{alarmStatus,jdbcType=INTEGER},
        #{appProtocol,jdbcType=VARCHAR},#{clearText,jdbcType=VARCHAR},#{requestUrl,jdbcType=VARCHAR},#{cve,jdbcType=VARCHAR},#{severityLevel,jdbcType=VARCHAR},
        #{vulnerabilityName,jdbcType=VARCHAR},#{classType,jdbcType=VARCHAR},#{srcUserName,jdbcType=VARCHAR},#{passwd,jdbcType=VARCHAR},#{medium,jdbcType=BIGINT},
        #{High,jdbcType=BIGINT},#{Low,jdbcType=BIGINT},#{aggCount,jdbcType=BIGINT},#{eventCode,jdbcType=VARCHAR},#{updateTime,jdbcType=VARCHAR},
        #{source,jdbcType=INTEGER},#{chartId,jdbcType=INTEGER},#{assetIp,jdbcType=VARCHAR},#{assetName,jdbcType=VARCHAR},#{destSecurityZone,jdbcType=VARCHAR},
        #{assetType,jdbcType=VARCHAR},#{assetTags,jdbcType=VARCHAR})
        ON DUPLICATE KEY UPDATE
        end_time = values (end_time),alarm_result = coalesce(greatest(values(alarm_result), alarm_result),values(alarm_result),alarm_result),
        alarm_status  = values (alarm_status) , app_protocol = values (app_protocol), clear_text = values (clear_text),
        request_url = values (request_url) ,cve = values (cve), severity_level = values (severity_level), vulnerability_name = values (vulnerability_name),class_type = values (class_type),
        src_user_name = values (src_user_name),passwd = values (passwd),`Medium` = `Medium` +#{Medium,jdbcType=BIGINT},High = High + #{High,jdbcType=BIGINT}, Low = Low + #{Low,jdbcType=BIGINT},
        agg_count = agg_count + #{aggCount,jdbcType=BIGINT} ,update_time = values (update_time),`source` = values (`source`), asset_name = values (asset_name) , dest_security_zone = values (dest_security_zone) ,
        asset_type = values (asset_type),asset_tags = values (asset_tags)
    </insert>

    <select id="queryListCount" parameterType="java.util.Map" resultType="java.lang.Long">
        SELECT count(1) FROM (
        SELECT
        DATE_FORMAT(MAX( ts.end_time ),'%Y-%m-%d %T') as endTime,
        DATE_FORMAT(MIN( ts.start_time ),'%Y-%m-%d %T') as startTime,
        ts.asset_ip as assetIp,
        ti.assetType,
        count( 1 ) AS aggCount,
        MAX( ts.alarm_status ) AS alarmStatus ,
        MAX( ts.alarm_result ) AS alarmResults,
        ti.assetName,
        IFNULL(f.`name`,'未分配') as destSecurityZone
        FROM
        t_vul_analysis_sub ts
        LEFT JOIN `bigdata-web`.t_asset_info ti on ts.asset_ip = ti.assetIp
        LEFT JOIN `bigdata-web`.t_ailpha_network_segment e ON e.relation_type='SECURITY_ZONE' AND ti.assetIpNum BETWEEN e.first_ip AND e.last_ip
        LEFT JOIN `bigdata-web`.t_ailpha_security_zone f ON e.relation_id = f.id
        LEFT JOIN `bigdata-web`.t_vulnerability_info tf on ts.cve = tf.cve_code
        WHERE
        ts.end_time BETWEEN #{startTime} AND #{endTime}
        AND ts.chart_id = #{chartId}
        <if test="assetName != null and assetName != ''">
            AND ti.assetName like concat('%',#{assetName},'%')
        </if>
        <if test="assetIp != null and assetIp != ''">
            AND ts.asset_ip like concat('%',#{assetIp},'%')
        </if>
        <if test="assetType != null and assetType != ''">
            AND ti.assetType = #{assetType}
        </if>
        <if test="assetTags != null and assetTags != ''">
            AND ti.assetTags like concat('%',#{assetTags},'%')
        </if>
        <if test="source != null and source != ''">
            AND ti.source = #{source}
        </if>
        <if test="appProtocol != null and  appProtocol.size() > 0">
            AND ts.app_protocol IN
            <foreach collection="appProtocol" separator="," open="(" close=")"  index="index" item="appPcl">
                #{appPcl}
            </foreach>
        </if>
        <if test="vulnerabilityName != null and vulnerabilityName != ''">
            AND tf.vulnerability_name like concat('%',#{vulnerabilityName},'%')
        </if>
        GROUP BY ts.asset_ip
        ORDER BY
        <choose>
            <when test="order != null and order != ''">
                ${order}
            </when>
            <otherwise>
                endTime desc
            </otherwise>
        </choose>
        ) a
        <if test="alarmResultsVal != null and  alarmResultsVal.size() > 0">
            WHERE a.alarmResults IN
            <foreach collection="alarmResultsVal" separator="," open="(" close=")"  index="index" item="almRst">
                #{almRst}
            </foreach>
        </if>
    </select>


    <select id="queryList" parameterType="java.util.Map" resultType="java.util.Map">
        SELECT * FROM (
        SELECT
        DATE_FORMAT(MAX( ts.end_time ),'%Y-%m-%d %T') as endTime,
        DATE_FORMAT(MIN( ts.start_time ),'%Y-%m-%d %T') as startTime,
        ts.asset_ip as assetIp,
        ti.assetType,
        count( 1 ) AS aggCount,
        MAX( ts.alarm_result ) AS alarmResults ,
        ti.assetName,
        IFNULL(ts.dest_security_zone,IF(f.`name` is null,'',CONCAT('zone_name:',f.`name`))) AS destSecurityZone
        FROM
        t_vul_analysis_sub ts
        LEFT JOIN `bigdata-web`.t_asset_info ti on ts.asset_ip = ti.assetIp
        LEFT JOIN `bigdata-web`.t_ailpha_network_segment e ON e.relation_type='SECURITY_ZONE' AND ti.assetIpNum BETWEEN e.first_ip AND e.last_ip
        LEFT JOIN `bigdata-web`.t_ailpha_security_zone f ON e.relation_id = f.id
        LEFT JOIN `bigdata-web`.t_vulnerability_info tf on ts.cve = tf.cve_code
        WHERE
        ts.end_time BETWEEN #{startTime} AND #{endTime}
        AND ts.chart_id = #{chartId}
        <if test="assetName != null and assetName != ''">
            AND ti.assetName like concat('%',#{assetName},'%')
        </if>
        <if test="assetIp != null and assetIp != ''">
            AND ts.asset_ip like concat('%',#{assetIp},'%')
        </if>
        <if test="assetType != null and assetType != ''">
            AND ti.assetType = #{assetType}
        </if>
        <if test="assetTags != null and assetTags != ''">
            AND ti.assetTags like concat('%',#{assetTags},'%')
        </if>
        <if test="source != null and source != ''">
            AND ti.source = #{source}
        </if>
        <if test="appProtocol != null and  appProtocol.size() > 0">
            AND ts.app_protocol IN
            <foreach collection="appProtocol" separator="," open="(" close=")"  index="index" item="appPcl">
                #{appPcl}
            </foreach>
        </if>
        <if test="vulnerabilityName != null and vulnerabilityName != ''">
            AND tf.vulnerability_name like concat('%',#{vulnerabilityName},'%')
        </if>
        GROUP BY ts.asset_ip
       ) a
        <if test="alarmResultsVal != null and  alarmResultsVal.size() > 0">
            WHERE a.alarmResults IN
            <foreach collection="alarmResultsVal" separator="," open="(" close=")"  index="index" item="almRst">
                #{almRst}
            </foreach>
        </if>
        ORDER BY
        <choose>
            <when test="order != null and order != ''">
               ${order}
            </when>
            <otherwise>
                endTime desc
            </otherwise>
        </choose>
        LIMIT ${page} , ${size}
    </select>


    <select id="querySubListCount" parameterType="java.util.Map" resultType="java.lang.Long">
        SELECT count(1) FROM (
        SELECT
        DATE_FORMAT( ts.end_time, '%Y-%m-%d %T' ) AS endTime,
        DATE_FORMAT( ts.start_time, '%Y-%m-%d %T' ) AS startTime,
        ti.assetName,
        ts.asset_ip AS assetIp,
        IFNULL(f.`name`,'未分配') as destSecurityZone,
        ti.assetType,
        agg_count AS aggCount,
        ts.alarm_result AS alarmResults,
        ts.cve,
        tf.vulnerability_name AS vulnerabilityName,
        ts.app_protocol AS appProtocol,
        ts.clear_text AS clearText,
        ts.request_url AS requestUrl,
        tf.severity_level AS severityLevel,
        tf.class_type AS classType,
        ts.src_user_name AS srcUserName,
        ts.passwd
        FROM
        t_vul_analysis_sub ts
        LEFT JOIN `bigdata-web`.t_asset_info ti ON ts.asset_ip = ti.assetIp
        LEFT JOIN `bigdata-web`.t_ailpha_network_segment e ON e.relation_type = 'SECURITY_ZONE'
        AND ti.assetIpNum BETWEEN e.first_ip
        AND e.last_ip
        LEFT JOIN `bigdata-web`.t_ailpha_security_zone f ON e.relation_id = f.id
        LEFT JOIN `bigdata-web`.t_vulnerability_info tf ON ts.cve = tf.cve_code
        WHERE
        ts.end_time BETWEEN #{startTime} AND #{endTime}
        AND ts.chart_id = #{chartId}
        <if test="assetName != null and assetName != ''">
            AND ti.assetName like concat('%',#{assetName},'%')
        </if>
        <if test="assetIp != null and assetIp != ''">
            AND ts.asset_ip like concat('%',#{assetIp},'%')
        </if>
        <if test="assetType != null and assetType != ''">
            AND ti.assetType = #{assetType}
        </if>
        <if test="assetTags != null and assetTags != ''">
            AND ti.assetTags like concat('%',#{assetTags},'%')
        </if>
        <if test="source != null and source != ''">
            AND ti.source = #{source}
        </if>
        <if test="appProtocol != null and  appProtocol.size() > 0">
            AND ts.app_protocol IN
            <foreach collection="appProtocol" separator="," open="(" close=")"  index="index" item="appPcl">
                #{appPcl}
            </foreach>
        </if>
        <if test="vulnerabilityName != null and vulnerabilityName != ''">
            AND tf.vulnerability_name like concat('%',#{vulnerabilityName},'%')
        </if>
       ) a
        <if test="alarmResultsVal != null and  alarmResultsVal.size() > 0">
            WHERE a.alarmResults IN
            <foreach collection="alarmResultsVal" separator="," open="(" close=")"  index="index" item="almRst">
                #{almRst}
            </foreach>
        </if>
        ORDER BY
        <choose>
            <when test="order != null and order != ''">
                ${order}
            </when>
            <otherwise>
                endTime desc
            </otherwise>
        </choose>

    </select>

    <select id="querySubListCveCount" parameterType="java.util.Map" resultType="java.util.Map">
        SELECT DISTINCT assetIp,count(assetIp) as cveCount FROM
        (
        SELECT
        DISTINCT ts.asset_ip AS assetIp,
        ts.cve, MAX( ts.alarm_result ) AS alarmResults
        FROM
        t_vul_analysis_sub ts
        LEFT JOIN `bigdata-web`.t_asset_info ti ON ts.asset_ip = ti.assetIp
        LEFT JOIN `bigdata-web`.t_ailpha_network_segment e ON e.relation_type = 'SECURITY_ZONE'
        AND ti.assetIpNum BETWEEN e.first_ip
        AND e.last_ip
        LEFT JOIN `bigdata-web`.t_ailpha_security_zone f ON e.relation_id = f.id
        LEFT JOIN `bigdata-web`.t_vulnerability_info tf ON ts.cve = tf.cve_code
        WHERE
        ts.end_time BETWEEN #{startTime} AND #{endTime}
        AND ts.chart_id = #{chartId}
        <if test="assetName != null and assetName != ''">
            AND ti.assetName like concat('%',#{assetName},'%')
        </if>
        <if test="assetIp != null and  assetIp.size() > 0">
            AND ts.asset_ip IN
            <foreach collection="assetIp" separator="," open="(" close=")"  index="index" item="ip">
                #{ip}
            </foreach>
        </if>
        <if test="assetType != null and assetType != ''">
            AND ti.assetType = #{assetType}
        </if>
        <if test="assetTags != null and assetTags != ''">
            AND ti.assetTags like concat('%',#{assetTags},'%')
        </if>
        <if test="source != null and source != ''">
            AND ti.source = #{source}
        </if>
        <if test="appProtocol != null and  appProtocol.size() > 0">
            AND ts.app_protocol IN
            <foreach collection="appProtocol" separator="," open="(" close=")"  index="index" item="appPcl">
                #{appPcl}
            </foreach>
        </if>
        <if test="assetIps != null and  assetIps.size() > 0">
            AND ts.asset_ip IN
            <foreach collection="assetIps" separator="," open="(" close=")"  index="index" item="assIp">
                #{assIp}
            </foreach>
        </if>
        <if test="vulnerabilityName != null and vulnerabilityName != ''">
            AND tf.vulnerability_name like concat('%',#{vulnerabilityName},'%')
        </if>
        GROUP BY
        ts.asset_ip,ts.cve) c
        <if test="alarmResultsVal != null and  alarmResultsVal.size() > 0">
            WHERE c.alarmResults IN
            <foreach collection="alarmResultsVal" separator="," open="(" close=")"  index="index" item="almRst">
                #{almRst}
            </foreach>
        </if>
        GROUP BY assetIp
    </select>

    <select id="querySubList" parameterType="java.util.Map" resultType="java.util.Map">
        SELECT * FROM (
        SELECT
        DATE_FORMAT( ts.end_time, '%Y-%m-%d %T' ) AS endTime,
        DATE_FORMAT( ts.start_time, '%Y-%m-%d %T' ) AS startTime,
        ti.assetName,
        ts.asset_ip AS assetIp,
        IFNULL(ts.dest_security_zone,IF(f.`name` is null,'',CONCAT('zone_name:',f.`name`))) AS destSecurityZone,
        ti.assetType,
        agg_count AS aggCount,
        ts.alarm_result AS alarmResults,
        ts.cve,
        tf.vulnerability_name AS vulnerabilityName,
        ts.app_protocol AS appProtocol,
        ts.clear_text AS clearText,
        ts.request_url AS requestUrl,
        tf.severity_level AS severityLevel,
        tf.class_type AS classType,
        ts.src_user_name AS srcUserName,
        ts.passwd
        FROM
        t_vul_analysis_sub ts
        LEFT JOIN `bigdata-web`.t_asset_info ti ON ts.asset_ip = ti.assetIp
        LEFT JOIN `bigdata-web`.t_ailpha_network_segment e ON e.relation_type = 'SECURITY_ZONE'
        AND ti.assetIpNum BETWEEN e.first_ip
        AND e.last_ip
        LEFT JOIN `bigdata-web`.t_ailpha_security_zone f ON e.relation_id = f.id
        LEFT JOIN `bigdata-web`.t_vulnerability_info tf ON ts.cve = tf.cve_code
        WHERE
        ts.end_time BETWEEN #{startTime} AND #{endTime}
        AND ts.chart_id = #{chartId}
        <if test="assetName != null and assetName != ''">
            AND ti.assetName like concat('%',#{assetName},'%')
        </if>
        <if test="assetIp != null and assetIp != ''">
            AND ts.asset_ip like concat('%',#{assetIp},'%')
        </if>
        <if test="assetType != null and assetType != ''">
            AND ti.assetType = #{assetType}
        </if>
        <if test="assetTags != null and assetTags != ''">
            AND ti.assetTags like concat('%',#{assetTags},'%')
        </if>
        <if test="source != null and source != ''">
            AND ti.source = #{source}
        </if>
        <if test="appProtocol != null and  appProtocol.size() > 0">
            AND ts.app_protocol IN
            <foreach collection="appProtocol" separator="," open="(" close=")"  index="index" item="appPcl">
                #{appPcl}
            </foreach>
        </if>
        <if test="assetIps != null and  assetIps.size() > 0">
            AND ts.asset_ip IN
            <foreach collection="assetIps" separator="," open="(" close=")"  index="index" item="assIp">
                #{assIp}
            </foreach>
        </if>
        <if test="vulnerabilityName != null and vulnerabilityName != ''">
            AND tf.vulnerability_name like concat('%',#{vulnerabilityName},'%')
        </if>
       ) a
        <if test="alarmResultsVal != null and  alarmResultsVal.size() > 0">
            WHERE a.alarmResults IN
            <foreach collection="alarmResultsVal" separator="," open="(" close=")"  index="index" item="almRst">
                #{almRst}
            </foreach>
        </if>
        ORDER BY
        <choose>
            <when test="order != null and order != ''">
                ${order}
            </when>
            <otherwise>
                endTime desc
            </otherwise>
        </choose>
        LIMIT ${page} , ${size}
    </select>


    <select id="querySubListById" parameterType="java.util.List" resultType="java.util.Map">
        SELECT
        DATE_FORMAT( ts.end_time, '%Y-%m-%d %T' ) AS endTime,
        DATE_FORMAT( ts.start_time, '%Y-%m-%d %T' ) AS startTime,
        ti.assetName,
        ts.asset_ip AS assetIp,
        IFNULL(f.`name`,'未分配') as destSecurityZone,
        ti.assetType,
        agg_count AS aggCount,
        ts.alarm_status AS alarmStatus,
        ts.alarm_result AS alarmResults,
        ts.cve,
        tf.vulnerability_name AS vulnerabilityName,
        ts.app_protocol AS appProtocol,
        ts.clear_text AS clearText,
        ts.request_url AS requestUrl,
        tf.severity_level AS severityLevel,
        tf.class_type AS classType,
        ts.src_user_name AS srcUserName,
        ts.passwd
        FROM
        t_vul_analysis_sub ts
        LEFT JOIN `bigdata-web`.t_asset_info ti ON ts.asset_ip = ti.assetIp
        LEFT JOIN `bigdata-web`.t_ailpha_network_segment e ON e.relation_type = 'SECURITY_ZONE'
        AND ti.assetIpNum BETWEEN e.first_ip
        AND e.last_ip
        LEFT JOIN `bigdata-web`.t_ailpha_security_zone f ON e.relation_id = f.id
        LEFT JOIN `bigdata-web`.t_vulnerability_info tf ON ts.cve = tf.cve_code
        WHERE
        ts.id  IN
        <foreach collection="list" index="index" item="id" open="(" close=")" separator=",">
            #{id,jdbcType=VARCHAR}
        </foreach>
    </select>

    <update id="updateByParams" parameterType="java.util.Map">
        UPDATE
        t_vul_analysis_sub tb
        SET
        tb.alarm_status = ${alarmStatus}
        WHERE
        tb.id IN (
        SELECT * from (
        SELECT ts.id
        from
        t_vul_analysis_sub ts
        LEFT JOIN `bigdata-web`.t_asset_info ti ON ts.asset_ip = ti.assetIp
        LEFT JOIN `bigdata-web`.t_ailpha_network_segment e ON e.relation_type = 'SECURITY_ZONE'
        AND ti.assetIpNum BETWEEN e.first_ip
        AND e.last_ip
        LEFT JOIN `bigdata-web`.t_ailpha_security_zone f ON e.relation_id = f.id
        LEFT JOIN `bigdata-web`.t_vulnerability_info tf ON ts.cve = tf.cve_code
        WHERE
        ts.end_time BETWEEN #{startTime} AND #{endTime}
        AND ts.chart_id = #{chartId}
        <if test="assetName != null and assetName != ''">
            AND ti.assetName like concat('%',#{assetName},'%')
        </if>
        <if test="assetIp != null and assetIp != ''">
            AND ts.asset_ip like concat('%',#{assetIp},'%')
        </if>
        <if test="assetType != null and assetType != ''">
            AND ti.assetType = #{assetType}
        </if>
        <if test="assetTags != null and assetTags != ''">
            AND ti.assetTags like concat('%',#{assetTags},'%')
        </if>
        <if test="source != null and source != ''">
            AND ti.source = #{source}
        </if>
        <if test="appProtocol != null and appProtocol.size() > 0">
            AND ts.app_protocol IN
            <foreach collection="appProtocol" separator="," open="(" close=")" index="index" item="appPcl">
                #{appPcl}
            </foreach>
        </if>
        <if test="assetIps != null and assetIps.size() > 0">
            AND ts.asset_ip IN
            <foreach collection="assetIps" separator="," open="(" close=")" index="index" item="ips">
                #{ips}
            </foreach>
        </if>
        <if test="vulnerabilityName != null and vulnerabilityName != ''">
            AND tf.vulnerability_name like concat('%',#{vulnerabilityName},'%')
        </if>
        ) a
        )
    </update>


    <update id="updateByIds">
        UPDATE
        t_vul_analysis_sub ts
        SET
        ts.alarm_status = #{status,jdbcType=INTEGER}
        WHERE
        ts.id  IN
        <foreach collection="id" index="index" item="id" open="(" close=")" separator=",">
            #{id,jdbcType=VARCHAR}
        </foreach>
    </update>


    <select id="queryTop10" parameterType="java.util.Map" resultType="java.util.Map">
    SELECT * FROM
    (
        SELECT
        ts.asset_ip as assetIp,
        sum( ts.agg_count ) AS `count`,
        sum( ts.high ) AS High,
        sum( ts.`medium` ) AS `Medium`,
        sum( ts.low ) AS Low,
        MAX( ts.alarm_result ) AS alarmResults
        FROM
        t_vul_analysis_sub ts
        LEFT JOIN `bigdata-web`.t_asset_info ti ON ts.asset_ip = ti.assetIp
        LEFT JOIN `bigdata-web`.t_ailpha_network_segment e ON e.relation_type = 'SECURITY_ZONE'
        AND ti.assetIpNum BETWEEN e.first_ip
        AND e.last_ip
        LEFT JOIN `bigdata-web`.t_ailpha_security_zone f ON e.relation_id = f.id
        LEFT JOIN `bigdata-web`.t_vulnerability_info tf ON ts.cve = tf.cve_code
        WHERE
        ts.end_time BETWEEN #{startTime} AND #{endTime}
        AND ts.chart_id = #{chartId}
        <if test="assetName != null and assetName != ''">
            AND ti.assetName like concat('%',#{assetName},'%')
        </if>
        <if test="assetIp != null and assetIp != ''">
            AND ts.asset_ip like concat('%',#{assetIp},'%')
        </if>
        <if test="assetType != null and assetType != ''">
            AND ti.assetType = #{assetType}
        </if>
        <if test="assetTags != null and assetTags != ''">
            AND ti.assetTags like concat('%',#{assetTags},'%')
        </if>
        <if test="source != null and source != ''">
            AND ti.source = #{source}
        </if>
        <if test="appProtocol != null and  appProtocol.size() > 0">
            AND ts.app_protocol IN
            <foreach collection="appProtocol" separator="," open="(" close=")"  index="index" item="appPcl">
                #{appPcl}
            </foreach>
        </if>
        <if test="vulnerabilityName != null and vulnerabilityName != ''">
            AND tf.vulnerability_name like concat('%',#{vulnerabilityName},'%')
        </if>
        GROUP BY
        ts.asset_ip
      ) a
        <if test="alarmResultsVal != null and  alarmResultsVal.size() > 0">
            WHERE a.alarmResults IN
            <foreach collection="alarmResultsVal" separator="," open="(" close=")"  index="index" item="almRst">
                #{almRst}
            </foreach>
        </if>
        ORDER BY `count` desc
    LIMIT 10
    </select>


    <select id="queryProportion" parameterType="java.util.Map" resultType="java.util.Map">
        SELECT  * FROM
        (
        SELECT
        tf.vulnerability_name as vulnerabilityName,
        sum( ts.agg_count ) AS `count`,
        MAX( ts.alarm_result ) AS alarmResults
        FROM
        t_vul_analysis_sub ts
        LEFT JOIN `bigdata-web`.t_asset_info ti ON ts.asset_ip = ti.assetIp
        LEFT JOIN `bigdata-web`.t_ailpha_network_segment e ON e.relation_type = 'SECURITY_ZONE'
        AND ti.assetIpNum BETWEEN e.first_ip
        AND e.last_ip
        LEFT JOIN `bigdata-web`.t_ailpha_security_zone f ON e.relation_id = f.id
        LEFT JOIN `bigdata-web`.t_vulnerability_info tf ON ts.cve = tf.cve_code
        WHERE
        ts.end_time BETWEEN #{startTime} AND #{endTime}
        AND ts.chart_id = #{chartId}
        AND tf.vulnerability_name is not null
        <if test="assetName != null and assetName != ''">
            AND ti.assetName like concat('%',#{assetName},'%')
        </if>
        <if test="assetIp != null and assetIp != ''">
            AND ts.asset_ip like concat('%',#{assetIp},'%')
        </if>
        <if test="assetType != null and assetType != ''">
            AND ti.assetType = #{assetType}
        </if>
        <if test="assetTags != null and assetTags != ''">
            AND ti.assetTags like concat('%',#{assetTags},'%')
        </if>
        <if test="source != null and source != ''">
            AND ti.source = #{source}
        </if>
        <if test="appProtocol != null and appProtocol.size() > 0">
            AND ts.app_protocol IN
            <foreach collection="appProtocol" separator="," open="(" close=")" index="index" item="appPcl">
                #{appPcl}
            </foreach>
        </if>
        <if test="vulnerabilityName != null and vulnerabilityName != ''">
            AND tf.vulnerability_name like concat('%',#{vulnerabilityName},'%')
        </if>
        GROUP BY
        tf.vulnerability_name) a
        <if test="alarmResultsVal != null and  alarmResultsVal.size() > 0">
            WHERE a.alarmResults IN
            <foreach collection="alarmResultsVal" separator="," open="(" close=")"  index="index" item="almRst">
                #{almRst}
            </foreach>
        </if>
        ORDER BY `count` desc
    </select>
</mapper>

