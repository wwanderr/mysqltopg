<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.dbapp.extension.xdr.threatMonitor.mapper.EventScenarioQueueMapper">
    <resultMap id="baseResultMap" type="com.dbapp.extension.xdr.threatMonitor.entity.ScenarioWrapper">
        <result column="security_event_Id" property="securityEventId" jdbcType="BIGINT"/>
        <result column="scenario_template_id" property="scenarioTemplateId" jdbcType="VARCHAR"/>
        <result column="focus_ip" property="focusIp" jdbcType="VARCHAR"/>
        <result column="target_ip" property="targetIp" jdbcType="VARCHAR"/>
        <result column="event_code" property="eventCode" jdbcType="VARCHAR"/>
        <result column="src_address" property="srcAddress" jdbcType="VARCHAR"/>
        <result column="dest_address" property="destAddress" jdbcType="VARCHAR"/>
        <result column="time_part" property="timePart" jdbcType="VARCHAR"/>
        <result column="alarm_info" property="alarmInfoList" jdbcType="VARCHAR" typeHandler="com.dbapp.extension.xdr.handler.JSONListHandler" javaType="com.dbapp.extension.xdr.logCorrelation.entity.AlarmInfo"/>
        <result column="start_time" property="startTime" jdbcType="TIMESTAMP"/>
        <result column="end_time" property="endTime" jdbcType="TIMESTAMP"/>
    </resultMap>

    <insert id="insertIgnore">
        INSERT IGNORE INTO t_event_scenario_queue
        (focus_ip, target_ip, event_code, scenario_template_id,
        src_address, dest_address, start_time, end_time, alarm_info, time_part)
        VALUES
        <foreach collection="datas" item="data" separator=",">
            (#{data.focusIp}, #{data.targetIp}, #{data.eventCode}, #{data.scenarioTemplateId},
            #{data.srcAddress}, #{data.destAddress}, #{data.startTime}, #{data.endTime}, #{data.alarmInfoList,typeHandler=com.dbapp.extension.xdr.handler.JSONListHandler,javaType=com.dbapp.extension.xdr.logCorrelation.entity.AlarmInfo}, #{data.timePart})
        </foreach>
    </insert>

    <select id="selectLast" resultMap="baseResultMap">
        SELECT t.*,i.id security_event_Id FROM t_event_scenario_queue t inner join t_security_incidents i
        on t.event_code = i.event_code
        where t.is_job_commit=0 order by t.create_time desc limit 1000;
    </select>

    <update id="updateSyncSuccessBatch">
        update t_event_scenario_queue set is_job_commit =1 where (focus_ip, target_ip, event_code, scenario_template_id ) in
        <foreach collection="datas" item="data" open="(" close=")" separator=",">
            (#{data.focusIp}, #{data.targetIp}, #{data.eventCode}, #{data.scenarioTemplateId})
        </foreach>
    </update>

    <delete id="tryClean">
        delete t from t_event_scenario_queue t
        left join t_security_incidents i
        on t.event_code=i.event_code
        where t.create_time &lt; #{time} and (t.is_job_commit=1 or i.event_code is null);
    </delete>
</mapper>