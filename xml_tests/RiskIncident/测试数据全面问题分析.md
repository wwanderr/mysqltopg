# RiskIncidentæµ‹è¯•æ•°æ®å…¨é¢é—®é¢˜åˆ†æä¸ä¿®å¤

## æ£€æŸ¥æ—¶é—´ï¼š2026-01-30

## é—®é¢˜æ±‡æ€»

### ğŸ”´ é—®é¢˜1ï¼štemplate_idç±»å‹ä¸åŒ¹é…ï¼ˆä¸¥é‡ï¼‰
**å½±å“æ–¹æ³•ï¼š** æ‰€æœ‰æ¶‰åŠtemplate_idçš„æŸ¥è¯¢

**é—®é¢˜æè¿°ï¼š**
- DDLå®šä¹‰ï¼š`template_id int8` ï¼ˆæ•´æ•°ï¼‰
- æµ‹è¯•æ•°æ®ï¼š`template_id = '2001'` ï¼ˆå­—ç¬¦ä¸²ï¼‰

**å½±å“ï¼š**
```sql
-- éªŒè¯æŸ¥è¯¢ä¸­çš„JOIN
LEFT JOIN "t_event_template" te ON ri.template_id = te.id::varchar
```
éœ€è¦ç±»å‹è½¬æ¢ï¼Œå½±å“æ€§èƒ½

**ä¿®å¤ï¼š**
```sql
-- ä¿®å¤å‰
(1001, 'RISK-2026-001', 'é«˜çº§æŒç»­æ€§å¨èƒ(APT)æ”»å‡»', '2001', 'High', ...

-- ä¿®å¤å
(1001, 'RISK-2026-001', 'é«˜çº§æŒç»­æ€§å¨èƒ(APT)æ”»å‡»', 2001, 'High', ...
```

---

### ğŸ”´ é—®é¢˜2ï¼šjudgeResultsæŸ¥è¯¢æ¡ä»¶ç±»å‹é”™è¯¯ï¼ˆä¸¥é‡ï¼‰
**å½±å“æ–¹æ³•ï¼š** getRiskList, getCount, getCountByStatus, queryEventCount, queryIncidentsCount, queryKillChains

**é—®é¢˜æè¿°ï¼š**
- æµ‹è¯•ä»£ç æŸ¥è¯¢ï¼š`judgeResults = Arrays.asList("confirmed")` ï¼ˆå­—ç¬¦ä¸²ï¼‰
- XMLæ¡ä»¶ï¼š`judge_result in (#{judgeResults})`
- æ•°æ®åº“å­—æ®µï¼š`judge_result` æ˜¯æ•´æ•°ç±»å‹ï¼ˆ1,2,3,4ï¼‰

**æ•°æ®å€¼å«ä¹‰ï¼š**
```sql
-- æµ‹è¯•æ•°æ®ä¸­çš„å®šä¹‰
judge_result: 1, 'ç³»ç»Ÿè‡ªåŠ¨ç ”åˆ¤'
judge_result: 2, 'å¨èƒæƒ…æŠ¥å›è¿æ—¶åºç ”åˆ¤'
judge_result: 3, 'äººå·¥ç ”åˆ¤'
judge_result: 4, 'ä¸»åŠ¨æ”»å‡»ç ”åˆ¤'
judge_result: 0, ''ï¼ˆæœªç ”åˆ¤ï¼‰
```

**ä¿®å¤ï¼š**
```java
// ä¿®å¤å‰ï¼ˆé”™è¯¯ï¼‰
Arrays.asList("confirmed")

// ä¿®å¤åï¼ˆæ­£ç¡®ï¼‰
Arrays.asList("1", "2", "3")  // æˆ–è€…ç›´æ¥ä¼ æ•´æ•°
```

---

### ğŸŸ¡ é—®é¢˜3ï¼šsubCategoryæŸ¥è¯¢æ¡ä»¶ä¸åŒ¹é…ï¼ˆä¸­ç­‰ï¼‰
**å½±å“æ–¹æ³•ï¼š** getRiskList, getCount, getCountByStatus, queryEventCount, queryIncidentsCount, queryKillChains

**é—®é¢˜æè¿°ï¼š**
- æµ‹è¯•ä»£ç æŸ¥è¯¢ï¼š`subCategory = Arrays.asList("ç½‘ç»œé’“é±¼")`
- XMLæ¡ä»¶ï¼š`second_event_type_chinese in (...)`
- æµ‹è¯•æ•°æ®å€¼ï¼š
  - 'æŒç»­æ€§å¨èƒ'
  - 'å‹’ç´¢è½¯ä»¶'
  - 'Pass-the-Hash'
  - 'é‚®ä»¶é’“é±¼'
  - 'æ•°æ®çªƒå–'
  - 'SQLæ³¨å…¥'
  - 'DDoSæ”»å‡»'
  - 'æš´åŠ›ç ´è§£'
  - 'æœ¨é©¬ç¨‹åº'
  - 'æœ¬åœ°ææƒ'

**ä¿®å¤å»ºè®®ï¼š**
1. ä¿®æ”¹æµ‹è¯•ä»£ç ï¼Œä½¿ç”¨å®é™…å­˜åœ¨çš„å€¼
2. æˆ–è€…å¢åŠ 'ç½‘ç»œé’“é±¼'ç±»å‹çš„æµ‹è¯•æ•°æ®

---

### ğŸŸ¡ é—®é¢˜4ï¼šnameå­—æ®µLIKEæŸ¥è¯¢å¯èƒ½æ— ç»“æœï¼ˆä¸­ç­‰ï¼‰
**å½±å“æ–¹æ³•ï¼š** getRiskList, getCount

**é—®é¢˜æè¿°ï¼š**
- æµ‹è¯•ä»£ç æŸ¥è¯¢ï¼š`name = "APT"`
- XMLæ¡ä»¶ï¼š`name like '%' || #{name} || '%'`ï¼ˆæ¨¡ç³ŠåŒ¹é…ï¼‰
- æµ‹è¯•æ•°æ®ï¼š`name = 'é«˜çº§æŒç»­æ€§å¨èƒ(APT)æ”»å‡»'`

**åˆ†æï¼š**
åº”è¯¥èƒ½åŒ¹é…ï¼Œå› ä¸º'é«˜çº§æŒç»­æ€§å¨èƒ(APT)æ”»å‡»'åŒ…å«'APT'

**å»ºè®®ï¼š** ä¿æŒç°çŠ¶ï¼Œåº”è¯¥å¯ä»¥å·¥ä½œ

---

### ğŸŸ¡ é—®é¢˜5ï¼štagSearchæŸ¥è¯¢æ¡ä»¶å¯èƒ½ä¸åŒ¹é…ï¼ˆä¸­ç­‰ï¼‰
**å½±å“æ–¹æ³•ï¼š** getRiskList, getCount

**é—®é¢˜æè¿°ï¼š**
- æµ‹è¯•ä»£ç æŸ¥è¯¢ï¼š`tagSearch = Arrays.asList("APT", "æ¶æ„è½¯ä»¶")`
- XMLä¸­æ²¡æœ‰tagSearchçš„æŸ¥è¯¢æ¡ä»¶ï¼ˆgetRiskListæœªä½¿ç”¨ï¼‰
- æµ‹è¯•æ•°æ®æ ¼å¼ï¼š`'["APT", "æ•°æ®æ³„éœ²", "é«˜çº§å¨èƒ"]'` ï¼ˆJSONæ•°ç»„å­—ç¬¦ä¸²ï¼‰

**åˆ†æï¼š**
getRiskListçš„XMLä¸­æ²¡æœ‰ä½¿ç”¨tagSearchå‚æ•°ä½œä¸ºWHEREæ¡ä»¶ï¼Œåªæ˜¯è¿”å›å­—æ®µã€‚è¿™ä¸ªå‚æ•°åœ¨æ–¹æ³•ç­¾åä¸­ä½†æœªä½¿ç”¨ã€‚

**å»ºè®®ï¼š** è¿™å¯èƒ½æ˜¯æ­£å¸¸çš„ï¼ŒtagSearchç”¨äºå…¶ä»–ç›®çš„

---

### ğŸŸ¡ é—®é¢˜6ï¼škillChainæŸ¥è¯¢æ¡ä»¶å¯èƒ½ä¸åŒ¹é…ï¼ˆä¸­ç­‰ï¼‰
**å½±å“æ–¹æ³•ï¼š** getRiskList, getCount

**é—®é¢˜æè¿°ï¼š**
- æµ‹è¯•ä»£ç æŸ¥è¯¢ï¼š`killChain = Arrays.asList("ä¾¦å¯Ÿ", "æ­¦å™¨åŒ–")`
- XMLä¸­æ²¡æœ‰killChainçš„æŸ¥è¯¢æ¡ä»¶ï¼ˆgetRiskListæœªä½¿ç”¨ï¼‰
- æµ‹è¯•æ•°æ®æ ¼å¼ï¼š`'ä¾¦æŸ¥â†’æ­¦å™¨åŒ–â†’æŠ•é€’â†’åˆ©ç”¨â†’å®‰è£…â†’C&Câ†’ç›®æ ‡è¾¾æˆ'`

**åˆ†æï¼š**
ä¸tagSearchç±»ä¼¼ï¼ŒkillChainå‚æ•°åœ¨æ–¹æ³•ç­¾åä¸­ä½†getRiskListçš„XMLæœªä½¿ç”¨ã€‚

**å»ºè®®ï¼š** è¿™å¯èƒ½æ˜¯æ­£å¸¸çš„

---

### ğŸŸ¢ é—®é¢˜7ï¼šfocusObjectæŸ¥è¯¢åº”è¯¥èƒ½åŒ¹é…ï¼ˆä½ï¼‰
**å½±å“æ–¹æ³•ï¼š** getRiskList, getCount, getCountByStatus

**é—®é¢˜æè¿°ï¼š**
- æµ‹è¯•ä»£ç æŸ¥è¯¢ï¼š`focusObject = "attacker"`
- æµ‹è¯•æ•°æ®ï¼šåŒ…å«'attacker'å’Œ'victim'

**åˆ†æï¼š** åº”è¯¥èƒ½æ­£å¸¸åŒ¹é…

---

### ğŸ”´ é—®é¢˜8ï¼šsecondEventTypeChineseæŸ¥è¯¢æ¡ä»¶ä¸åŒ¹é…ï¼ˆä¸¥é‡ï¼‰
**å½±å“æ–¹æ³•ï¼š** getCountByStatus, queryEventCount, queryIncidentsCount, queryKillChains

**é—®é¢˜æè¿°ï¼š**
- æµ‹è¯•ä»£ç æŸ¥è¯¢ï¼š`secondEventTypeChinese = Arrays.asList("ç½‘ç»œé’“é±¼")`
- æµ‹è¯•æ•°æ®ä¸­æ²¡æœ‰'ç½‘ç»œé’“é±¼'ï¼Œåªæœ‰'é‚®ä»¶é’“é±¼'

**ä¿®å¤ï¼š**
```java
// ä¿®å¤å‰
Arrays.asList("ç½‘ç»œé’“é±¼")

// ä¿®å¤å
Arrays.asList("é‚®ä»¶é’“é±¼", "å‹’ç´¢è½¯ä»¶", "Pass-the-Hash")
```

---

### ğŸŸ¢ é—®é¢˜9ï¼ševentNameæŸ¥è¯¢åº”è¯¥èƒ½åŒ¹é…ï¼ˆä½ï¼‰
**å½±å“æ–¹æ³•ï¼š** getCountByStatus, queryEventCount, queryIncidentsCount, queryKillChains

**é—®é¢˜æè¿°ï¼š**
- æµ‹è¯•ä»£ç æŸ¥è¯¢ï¼š`eventName = "APT"`
- XMLæ¡ä»¶ï¼š`ti.name LIKE '%' || #{eventName} || '%'`
- æµ‹è¯•æ•°æ®ï¼šåŒ…å«'APT'çš„åç§°

**åˆ†æï¼š** åº”è¯¥èƒ½æ­£å¸¸åŒ¹é…

---

## å®Œæ•´ä¿®å¤æ–¹æ¡ˆ

### 1. ä¿®å¤test_data.sqlä¸­çš„template_id

```sql
-- ä¿®å¤ t_risk_incidents è¡¨
(1001, 'RISK-2026-001', 'é«˜çº§æŒç»­æ€§å¨èƒ(APT)æ”»å‡»', 2001, 'High', ...  -- ä»'2001'æ”¹ä¸º2001
(1002, 'RISK-2026-002', 'å‹’ç´¢è½¯ä»¶ä¼ æ’­å°è¯•', 2002, 'High', ...         -- ä»'2002'æ”¹ä¸º2002
(1003, 'RISK-2026-003', 'å†…ç½‘æ¨ªå‘ç§»åŠ¨æ”»å‡»', 2003, 'Medium', ...        -- ä»'2003'æ”¹ä¸º2003
(1004, 'RISK-2026-004', 'é’“é±¼é‚®ä»¶æ”»å‡»', 2004, 'Low', ...               -- ä»'2004'æ”¹ä¸º2004
(1005, 'RISK-2026-005', 'å¤§è§„æ¨¡æ•°æ®å¤–ä¼ ', 2005, 'High', ...            -- ä»'2005'æ”¹ä¸º2005
(1006, 'RISK-2026-006', 'SQLæ³¨å…¥æ”»å‡»', 2001, 'Medium', ...             -- ä»'2001'æ”¹ä¸º2001
(1007, 'RISK-2026-007', 'DDoSæ‹’ç»æœåŠ¡', 2002, 'High', ...              -- ä»'2002'æ”¹ä¸º2002
(1008, 'RISK-2026-008', 'æš´åŠ›ç ´è§£æ”»å‡»', 2003, 'Medium', ...            -- ä»'2003'æ”¹ä¸º2003
(1009, 'RISK-2026-009', 'æœ¨é©¬æ¤å…¥', 2004, 'High', ...                  -- ä»'2004'æ”¹ä¸º2004
(1010, 'RISK-2026-010', 'ææƒæ”»å‡»', 2005, 'High', ...                  -- ä»'2005'æ”¹ä¸º2005
```

### 2. ä¿®å¤RiskIncidentTestController.javaä¸­çš„æŸ¥è¯¢æ¡ä»¶

#### 2.1 ä¿®å¤getRiskListæ–¹æ³•
```java
// ä¿®å¤å‰
List<Map<String, Object>> list = mapper.getRiskList(
    "end_time desc",
    "APT",
    "2026-01-30 23:59:59",
    Arrays.asList("ç½‘ç»œé’“é±¼"),    // âŒ ä¸å­˜åœ¨
    Arrays.asList("unprocessed", "processing"),
    Arrays.asList("OK"),
    Arrays.asList("confirmed"),   // âŒ åº”è¯¥æ˜¯æ•´æ•°å­—ç¬¦ä¸²
    Arrays.asList("High", "Medium"),
    "attacker",
    "192.168",
    "2026-01-25 00:00:00",
    1,
    10L,
    0L,
    Arrays.asList("APT", "æ¶æ„è½¯ä»¶"),
    Arrays.asList("ä¾¦å¯Ÿ", "æ­¦å™¨åŒ–")
);

// ä¿®å¤å
List<Map<String, Object>> list = mapper.getRiskList(
    "end_time desc",
    "APT",
    "2026-01-30 23:59:59",
    Arrays.asList("æŒç»­æ€§å¨èƒ", "å‹’ç´¢è½¯ä»¶"),  // âœ“ ä½¿ç”¨å®é™…å­˜åœ¨çš„å€¼
    Arrays.asList("unprocessed", "processing"),
    Arrays.asList("OK"),
    Arrays.asList("1", "2"),      // âœ“ ä½¿ç”¨æ•´æ•°å­—ç¬¦ä¸²
    Arrays.asList("High", "Medium"),
    "attacker",
    "192.168",
    "2026-01-25 00:00:00",
    1,
    10L,
    0L,
    Arrays.asList("APT", "æ¶æ„è½¯ä»¶"),
    Arrays.asList("ä¾¦å¯Ÿ", "æ­¦å™¨åŒ–")
);
```

#### 2.2 ä¿®å¤getCountByStatusæ–¹æ³•
```java
// ä¿®å¤å‰
List<Map> list = mapper.getCountByStatus(
    "2026-01-25 00:00:00",
    "2026-01-30 23:59:59",
    "APT",
    "192.168.1.1",
    "attacker",
    Arrays.asList("ç½‘ç»œé’“é±¼"),    // âŒ ä¸å­˜åœ¨
    Arrays.asList("unprocessed", "processing"),
    Arrays.asList("OK"),
    Arrays.asList("confirmed"),   // âŒ åº”è¯¥æ˜¯æ•´æ•°å­—ç¬¦ä¸²
    Arrays.asList("High"),
    1
);

// ä¿®å¤å
List<Map> list = mapper.getCountByStatus(
    "2026-01-25 00:00:00",
    "2026-01-30 23:59:59",
    null,  // eventNameè®¾ä¸ºnullï¼ŒåŒ¹é…æ›´å¤šæ•°æ®
    null,  // focusIpè®¾ä¸ºnull
    null,  // focusObjectè®¾ä¸ºnull
    Arrays.asList("æŒç»­æ€§å¨èƒ", "å‹’ç´¢è½¯ä»¶", "Pass-the-Hash"),  // âœ“ ä½¿ç”¨å®é™…å€¼
    Arrays.asList("unprocessed", "processing"),
    Arrays.asList("OK"),
    Arrays.asList("1", "2"),      // âœ“ ä½¿ç”¨æ•´æ•°å­—ç¬¦ä¸²
    Arrays.asList("High"),
    1
);
```

#### 2.3 ä¿®å¤queryIncidentsCountæ–¹æ³•
```java
// ä¿®å¤å‰
List<CommonFilter> list = mapper.queryIncidentsCount(
    "2026-01-25 00:00:00",
    "2026-01-30 23:59:59",
    null,
    null,
    null,
    Arrays.asList("ç½‘ç»œé’“é±¼", "å‹’ç´¢è½¯ä»¶"),  // âŒ "ç½‘ç»œé’“é±¼"ä¸å­˜åœ¨
    null,
    null,
    null,
    null,
    null
);

// ä¿®å¤å
List<CommonFilter> list = mapper.queryIncidentsCount(
    "2026-01-25 00:00:00",
    "2026-01-30 23:59:59",
    null,
    null,
    null,
    Arrays.asList("é‚®ä»¶é’“é±¼", "å‹’ç´¢è½¯ä»¶", "Pass-the-Hash"),  // âœ“ ä½¿ç”¨å®é™…å€¼
    null,
    null,
    null,
    null,
    null
);
```

#### 2.4 ä¿®å¤getCountæ–¹æ³•
```java
// ä¿®å¤å‰
Long count = mapper.getCount(
    "APT",
    "2026-01-30 23:59:59",
    Arrays.asList("ç½‘ç»œé’“é±¼"),    // âŒ ä¸å­˜åœ¨
    Arrays.asList("unprocessed"),
    Arrays.asList("OK"),
    null,
    Arrays.asList("High", "Medium"),
    "attacker",
    "192.168",
    "2026-01-25 00:00:00",
    Arrays.asList("APT"),
    Arrays.asList("ä¾¦å¯Ÿ")
);

// ä¿®å¤å
Long count = mapper.getCount(
    "APT",
    "2026-01-30 23:59:59",
    Arrays.asList("æŒç»­æ€§å¨èƒ", "å‹’ç´¢è½¯ä»¶"),  // âœ“ ä½¿ç”¨å®é™…å€¼
    Arrays.asList("unprocessed"),
    Arrays.asList("OK"),
    null,
    Arrays.asList("High", "Medium"),
    "attacker",
    "192.168",
    "2026-01-25 00:00:00",
    Arrays.asList("APT"),
    Arrays.asList("ä¾¦å¯Ÿ")
);
```

---

## ä¿®å¤ä¼˜å…ˆçº§

### ğŸ”´ é«˜ä¼˜å…ˆçº§ï¼ˆç«‹å³ä¿®å¤ï¼‰
1. âœ… template_idç±»å‹ä»å­—ç¬¦ä¸²æ”¹ä¸ºæ•´æ•°
2. âœ… judgeResultsä»å­—ç¬¦ä¸²æ”¹ä¸ºæ•´æ•°å­—ç¬¦ä¸²
3. âœ… secondEventTypeChinese/subCategoryä½¿ç”¨å®é™…å­˜åœ¨çš„å€¼

### ğŸŸ¡ ä¸­ä¼˜å…ˆçº§ï¼ˆå»ºè®®ä¿®å¤ï¼‰
4. å¢åŠ æ›´å¤šæµ‹è¯•æ•°æ®ï¼Œè¦†ç›–ä¸åŒçš„subCategory

### ğŸŸ¢ ä½ä¼˜å…ˆçº§ï¼ˆå¯é€‰ï¼‰
5. ä¼˜åŒ–æŸ¥è¯¢æ¡ä»¶ï¼Œä½¿æµ‹è¯•æ›´å…¨é¢

---

## å—å½±å“çš„æµ‹è¯•æ–¹æ³•æ¸…å•

| æ–¹æ³•å | template_id | judgeResults | subCategory | çŠ¶æ€ |
|--------|-------------|--------------|-------------|------|
| aggClueSecurityEventByName | - | - | - | âœ… å·²ä¿®å¤ |
| mappingNormalSecurityEvent | - | - | - | âœ… åº”è¯¥æ­£å¸¸ |
| getRiskList | âœ… éœ€ä¿®å¤ | âœ… éœ€ä¿®å¤ | âœ… éœ€ä¿®å¤ | ğŸ”´ |
| getCountByStatus | âœ… éœ€ä¿®å¤ | âœ… éœ€ä¿®å¤ | âœ… éœ€ä¿®å¤ | ğŸ”´ |
| getByEventCode | âœ… éœ€ä¿®å¤ | - | - | ğŸŸ¡ |
| selectEventAndTempById | âœ… éœ€ä¿®å¤ | - | - | ğŸŸ¡ |
| selectAllByIdList | âœ… éœ€ä¿®å¤ | - | - | ğŸŸ¡ |
| queryEventCount | âœ… éœ€ä¿®å¤ | âœ… éœ€ä¿®å¤ | âœ… éœ€ä¿®å¤ | ğŸ”´ |
| queryIncidentsCount | âœ… éœ€ä¿®å¤ | âœ… éœ€ä¿®å¤ | âœ… éœ€ä¿®å¤ | ğŸ”´ |
| queryKillChains | âœ… éœ€ä¿®å¤ | âœ… éœ€ä¿®å¤ | âœ… éœ€ä¿®å¤ | ğŸ”´ |
| getCount | âœ… éœ€ä¿®å¤ | - | âœ… éœ€ä¿®å¤ | ğŸ”´ |

---

## æ€»ç»“

**å‘ç°é—®é¢˜æ€»æ•°ï¼š** 9ä¸ª
**ä¸¥é‡é—®é¢˜ï¼š** 3ä¸ªï¼ˆtemplate_idç±»å‹ã€judgeResultsç±»å‹ã€subCategoryå€¼ä¸å­˜åœ¨ï¼‰
**ä¸­ç­‰é—®é¢˜ï¼š** 4ä¸ª
**ä½é—®é¢˜ï¼š** 2ä¸ª

**ä¿®å¤æ–‡ä»¶ï¼š**
1. test_data.sql - ä¿®å¤template_idç±»å‹
2. RiskIncidentTestController.java - ä¿®å¤æŸ¥è¯¢æ¡ä»¶

**ä¿®å¤åé¢„æœŸï¼š**
- âœ… æ‰€æœ‰æŸ¥è¯¢åº”è¯¥èƒ½è¿”å›æ­£ç¡®çš„æ•°æ®
- âœ… ç±»å‹åŒ¹é…ï¼Œæ€§èƒ½ä¼˜åŒ–
- âœ… æµ‹è¯•ç”¨ä¾‹èƒ½æ­£ç¡®æ‰§è¡Œ
