# RiskIncident测试数据修复说明

## 问题分析

### 问题：testAggClueSecurityEventByName返回size=0

**原因分析：**

1. **category字段语言不匹配**
   - XML查询条件：`t.category = #{topEventType}`
   - 测试代码传入：`topEventType = "高级威胁"` （中文）
   - 原测试数据：`category = 'Advanced Threat'` （英文）
   - **结果**：查询条件不匹配，无数据返回

2. **template_id类型不匹配**
   - DDL定义：`template_id int8` （整数类型）
   - 原测试数据：`template_id = '2001'` （字符串类型）
   - JOIN条件：`t.template_id = tet.id`
   - **可能导致**：JOIN失败或性能问题

3. **excludeEventIds排除了关键数据**
   - 测试条件排除：`[5001, 5002]`
   - 如果只有5001和5002的category匹配，结果为空

## 修复内容

### 1. 修改category字段为中文

```sql
-- 修复前
(5001, 'RISK-2026-001', 'APT Attack Event', '2001', 'Advanced Threat', ...

-- 修复后
(5001, 'RISK-2026-001', 'APT Attack Event', 2001, '高级威胁', ...
```

### 2. 修改template_id为整数类型

```sql
-- 修复前：字符串类型
template_id = '2001'

-- 修复后：整数类型
template_id = 2001
```

### 3. 增加更多匹配数据

将5003的category也改为'高级威胁'，确保即使排除5001和5002，仍有数据可查。

## 修复后的测试数据

```sql
-- 5001: 高级威胁，High, OK （会被excludeEventIds排除）
(5001, 'RISK-2026-001', 'APT Attack Event', 2001, '高级威胁', 'APT Attack',
 '203.0.113.88', '192.168.10.50', 'target_ip', '192.168.10.50', 'High', 'OK',
 CURRENT_TIMESTAMP - INTERVAL '3 days', CURRENT_TIMESTAMP - INTERVAL '2 days 12 hours',
 15, 'unprocessed', CURRENT_TIMESTAMP - INTERVAL '3 days', CURRENT_TIMESTAMP),

-- 5002: 恶意软件，High, FAIL （会被excludeEventIds排除）
(5002, 'RISK-2026-002', 'Ransomware Event', 2002, '恶意软件', 'Ransomware',
 '198.51.100.150', '192.168.50.0/24', 'target_net', '192.168.50.1', 'High', 'FAIL',
 CURRENT_TIMESTAMP - INTERVAL '12 hours', CURRENT_TIMESTAMP - INTERVAL '11 hours',
 3, 'processing', CURRENT_TIMESTAMP - INTERVAL '12 hours', CURRENT_TIMESTAMP),

-- 5003: 高级威胁，Medium, OK （不会被排除，可以查到）✓
(5003, 'RISK-2026-003', 'Lateral Movement Event', 2003, '高级威胁', 'Pass-the-Hash',
 '192.168.20.88', '192.168.30.0/24', 'src_ip', '192.168.20.88', 'Medium', 'OK',
 CURRENT_TIMESTAMP - INTERVAL '2 hours', CURRENT_TIMESTAMP,
 8, 'unprocessed', CURRENT_TIMESTAMP - INTERVAL '2 hours', CURRENT_TIMESTAMP),
```

## 查询逻辑说明

### aggClueSecurityEventByName SQL逻辑

```sql
SELECT ...
FROM t_security_incidents t, t_event_template tet
WHERE tet.incident_type = 1  -- 只查incident_type=1的模板
  AND t.template_id = tet.id  -- JOIN条件
  AND t.end_time BETWEEN #{startTime} AND #{endTime}  -- 时间范围
  AND t.category = #{topEventType}  -- 类别匹配（中文）
  AND t.threat_severity IN (...)  -- 威胁等级
  AND t.alarm_results IN (...)  -- 告警结果
  AND t.id NOT IN (#{excludeEventIds})  -- 排除指定ID
GROUP BY event_name, t.focus
```

### 测试条件

```java
mapper.aggClueSecurityEventByName(
    "2026-01-25 00:00:00",             // startTime
    "2026-01-30 23:59:59",             // endTime
    "高级威胁",                         // topEventType（必须匹配）
    Arrays.asList("High", "Medium"),   // threatSeverity
    Arrays.asList("OK", "FAIL"),       // alarmResults
    Arrays.asList(5001L, 5002L)        // excludeEventIds（排除）
);
```

### 匹配分析

| ID | category | threat_severity | alarm_results | 排除? | 匹配? |
|----|----------|----------------|---------------|------|------|
| 5001 | 高级威胁 | High | OK | ✓ | ✗（被排除）|
| 5002 | 恶意软件 | High | FAIL | ✓ | ✗（被排除）|
| 5003 | 高级威胁 | Medium | OK | ✗ | ✓（匹配！）|
| 5004 | 社会工程 | Low | FAIL | ✗ | ✗（category不匹配）|
| 5005 | 数据外泄 | High | UNKNOWN | ✗ | ✗（category不匹配）|

**预期结果：** 返回1条记录（5003）

## t_event_template关联检查

查询要求`tet.incident_type = 1`（即true），检查测试数据：

```sql
(2001, '高级持续性威胁(APT)攻击', ..., true, ...)  -- ✓
(2002, '勒索软件传播尝试', ..., true, ...)        -- ✓
(2003, '内网横向移动攻击', ..., true, ...)        -- ✓
(2004, '钓鱼邮件攻击', ..., false, ...)           -- ✗
(2005, '大规模数据外传', ..., true, ...)          -- ✓
```

5003的template_id=2003，对应的incident_type=true，满足条件 ✓

## 验证步骤

1. **清空旧数据**
   ```sql
   DELETE FROM "t_security_incidents" WHERE id >= 5001 AND id <= 5005;
   DELETE FROM "t_event_template" WHERE id >= 2001 AND id <= 2005;
   ```

2. **执行test_data.sql**
   - 先插入t_event_template
   - 再插入t_security_incidents

3. **运行测试**
   ```
   GET http://localhost:8080/test/riskIncident/testAggClueSecurityEventByName
   ```

4. **预期输出**
   ```
   SUCCESS: 1
   样例: name=Lateral Movement Event, threatSeverity=Medium
   ```

## 其他注意事项

### 1. 时间范围
测试数据使用`CURRENT_TIMESTAMP - INTERVAL`动态生成时间，确保数据始终在查询范围内。

### 2. GROUP BY逻辑
SQL按`event_name`和`focus`分组，如果多条记录有相同的event_name和focus，会聚合为一条。

### 3. 数据类型映射
- `threat_severity`: 'High' → 3, 'Medium' → 2, 'Low' → 1
- `alarm_results`: 'OK' → 3, 'UNKNOWN' → 2, 'FAIL' → 1
- `alarm_status`: 'unprocessed' → 5, 'processing' → 4, 'processed' → 3

## 总结

**核心修复：**
1. ✅ category字段从英文改为中文
2. ✅ template_id从字符串改为整数
3. ✅ 增加5003作为'高级威胁'类别，确保有数据可查

**修复后：** testAggClueSecurityEventByName 应该返回 size=1
