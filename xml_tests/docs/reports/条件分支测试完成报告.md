# Intelligence ä¹‹åçš„æ¡ä»¶åˆ†æ”¯æµ‹è¯•å®ŒæˆæŠ¥å‘Š

## æ‰§è¡Œæ—¶é—´
**ç”Ÿæˆæ—¶é—´**: 2026-01-28  
**æ‰§è¡Œé˜¶æ®µ**: ç¬¬ä¸€é˜¶æ®µï¼ˆé«˜ä¼˜å…ˆçº§ï¼‰

## å®Œæˆæƒ…å†µæ±‡æ€»

### âœ… å·²å®Œæˆçš„æ¨¡å— (6ä¸ª)

| æ¨¡å— | æ–°å¢æµ‹è¯•æ–¹æ³•æ•° | æ¡ä»¶åˆ†æ”¯ç±»å‹ | çŠ¶æ€ |
|------|-------------|------------|------|
| **NoticeHistory** | 2 | `<choose>` orderByStr æ’åº | âœ… å®Œæˆ |
| **ProhibitHistory** | 9 | `<choose>` direction/orderByStr/domain | âœ… å®Œæˆ |
| **RiskIncident** | 2 | `<choose>` orderByStr æ’åº | âœ… å®Œæˆ |
| **RiskIncidentHistory** | 2 | `<choose>` orderByStr æ’åº | âœ… å®Œæˆ |
| **VulAnalysisSub** | 8 | `<choose>` order æ’åº | âœ… å®Œæˆ |
| **ThirdAuth** | 2 | `<choose>` machineCode/IP | âœ… å®Œæˆ |

**æ€»è®¡**: 25 ä¸ªæ–°æµ‹è¯•æ–¹æ³•

---

## è¯¦ç»†è¯´æ˜

### 1. NoticeHistory (2ä¸ªæµ‹è¯•)

#### æµ‹è¯•æ–¹æ³•:
1. `testGetNoticeHistoryDefaultOrder` - é»˜è®¤æ’åºï¼ˆorderByStr ä¸º nullï¼‰
   - **URL**: `/test/noticeHistory/testGetNoticeHistoryDefaultOrder`
   - **æ¡ä»¶**: `<when test="orderByStr == null or orderByStr == ''">` 
   - **é¢„æœŸ**: æŒ‰ contact_at desc æ’åº

2. `testGetNoticeHistoryCustomOrder` - è‡ªå®šä¹‰æ’åºï¼ˆorderByStr æœ‰å€¼ï¼‰
   - **URL**: `/test/noticeHistory/testGetNoticeHistoryCustomOrder`
   - **æ¡ä»¶**: `<otherwise> ${orderByStr} </otherwise>`
   - **é¢„æœŸ**: æŒ‰æŒ‡å®šå­—æ®µæ’åº

---

### 2. ProhibitHistory (9ä¸ªæµ‹è¯•)

#### æµ‹è¯•æ–¹æ³•:

**direction æ¡ä»¶åˆ†æ”¯ (3+3=6ä¸ª)**:

1. `testListByConditionDirectionIn` - å…¥å‘å°ç¦ (direction = 'in' â†’ 1)
   - **URL**: `/test/prohibitHistory/testListByConditionDirectionIn`

2. `testListByConditionDirectionOut` - å‡ºå‘å°ç¦ (direction = 'out' â†’ 2)
   - **URL**: `/test/prohibitHistory/testListByConditionDirectionOut`

3. `testListByConditionDirectionBoth` - åŒå‘å°ç¦ (direction = 'both' â†’ 3)
   - **URL**: `/test/prohibitHistory/testListByConditionDirectionBoth`

4. `testGetProhibitListCountDirectionIn` - ç»Ÿè®¡å…¥å‘å°ç¦
   - **URL**: `/test/prohibitHistory/testGetProhibitListCountDirectionIn`

5. `testGetProhibitListCountDirectionOut` - ç»Ÿè®¡å‡ºå‘å°ç¦
   - **URL**: `/test/prohibitHistory/testGetProhibitListCountDirectionOut`

6. `testGetProhibitListCountDirectionBoth` - ç»Ÿè®¡åŒå‘å°ç¦
   - **URL**: `/test/prohibitHistory/testGetProhibitListCountDirectionBoth`

**orderByStr æ¡ä»¶åˆ†æ”¯ (2ä¸ª)**:

7. `testGetProhibitListByConditionDefaultOrder` - é»˜è®¤æ’åº
   - **URL**: `/test/prohibitHistory/testGetProhibitListByConditionDefaultOrder`

8. `testGetProhibitListByConditionCustomOrder` - è‡ªå®šä¹‰æ’åº
   - **URL**: `/test/prohibitHistory/testGetProhibitListByConditionCustomOrder`

**domain æ¡ä»¶åˆ†æ”¯ (1ä¸ª)**:

9. `testGetHistoryByBlockListDomain` - åŸŸåå°ç¦æŸ¥è¯¢
   - **URL**: `/test/prohibitHistory/testGetHistoryByBlockListDomain`
   - **æ¡ä»¶**: `<when test="prohibitDomain"> t_prohibit_domain_history </when>`

---

### 3. RiskIncident (2ä¸ªæµ‹è¯•)

#### æµ‹è¯•æ–¹æ³•:
1. `testGetRiskListDefaultOrder` - é»˜è®¤æ’åº
   - **URL**: `/test/riskIncident/testGetRiskListDefaultOrder`
   - **æ¡ä»¶**: orderByStr ä¸º null

2. `testGetRiskListCustomOrder` - è‡ªå®šä¹‰æ’åº
   - **URL**: `/test/riskIncident/testGetRiskListCustomOrder`
   - **æ¡ä»¶**: orderByStr æœ‰å€¼ (threat_severity desc, start_time desc)

---

### 4. RiskIncidentHistory (2ä¸ªæµ‹è¯•)

#### æµ‹è¯•æ–¹æ³•:
1. `testGetRiskHistoryListDefaultOrder` - é»˜è®¤æ’åº
   - **URL**: `/test/riskIncidentHistory/testGetRiskHistoryListDefaultOrder`

2. `testGetRiskHistoryListCustomOrder` - è‡ªå®šä¹‰æ’åº
   - **URL**: `/test/riskIncidentHistory/testGetRiskHistoryListCustomOrder`
   - **æ¡ä»¶**: orderByStr æœ‰å€¼ (create_time asc, id asc)

---

### 5. VulAnalysisSub (8ä¸ªæµ‹è¯•)

#### æµ‹è¯•æ–¹æ³•:

**queryList æ–¹æ³• (2ä¸ª)**:
1. `testQueryListDefaultOrder` - é»˜è®¤æ’åºï¼ˆorder ä¸º nullï¼‰
   - **URL**: `/test/vulAnalysisSub/testQueryListDefaultOrder`

2. `testQueryListCustomOrder` - è‡ªå®šä¹‰æ’åºï¼ˆorder = "asset_ip desc"ï¼‰
   - **URL**: `/test/vulAnalysisSub/testQueryListCustomOrder`

**queryListCount æ–¹æ³• (2ä¸ª)**:
3. `testQueryListCountDefaultOrder` - é»˜è®¤æ’åº
   - **URL**: `/test/vulAnalysisSub/testQueryListCountDefaultOrder`

4. `testQueryListCountCustomOrder` - è‡ªå®šä¹‰æ’åºï¼ˆorder = "cve_id asc"ï¼‰
   - **URL**: `/test/vulAnalysisSub/testQueryListCountCustomOrder`

**querySubList æ–¹æ³• (2ä¸ª)**:
5. `testQuerySubListDefaultOrder` - é»˜è®¤æ’åº
   - **URL**: `/test/vulAnalysisSub/testQuerySubListDefaultOrder`

6. `testQuerySubListCustomOrder` - è‡ªå®šä¹‰æ’åºï¼ˆorder = "threat_severity desc"ï¼‰
   - **URL**: `/test/vulAnalysisSub/testQuerySubListCustomOrder`

**querySubListCount æ–¹æ³• (2ä¸ª)**:
7. `testQuerySubListCountDefaultOrder` - é»˜è®¤æ’åº
   - **URL**: `/test/vulAnalysisSub/testQuerySubListCountDefaultOrder`

8. `testQuerySubListCountCustomOrder` - è‡ªå®šä¹‰æ’åºï¼ˆorder = "update_time desc"ï¼‰
   - **URL**: `/test/vulAnalysisSub/testQuerySubListCountCustomOrder`

---

### 6. ThirdAuth (2ä¸ªæµ‹è¯•)

#### æµ‹è¯•æ–¹æ³•:
1. `testGetThirdAuthByMachineCode` - æŒ‰æœºå™¨ç æŸ¥è¯¢
   - **URL**: `/test/thirdAuth/testGetThirdAuthByMachineCode`
   - **æ¡ä»¶**: `<when test="machineCode != null and machineCode != ''"> machine_code = #{machineCode} </when>`
   - **å‚æ•°**: machineCode = "MACHINE-001"

2. `testGetThirdAuthByIp` - æŒ‰IPæŸ¥è¯¢
   - **URL**: `/test/thirdAuth/testGetThirdAuthByIp`
   - **æ¡ä»¶**: `<otherwise> #{ip} = ANY(string_to_array(ip, ',')) </otherwise>`
   - **å‚æ•°**: ip = "192.168.1.100", machineCode = null

---

## æŠ€æœ¯ç‰¹ç‚¹

### 1. **å¼‚å¸¸å¤„ç†**
æ‰€æœ‰æ–°å¢æµ‹è¯•æ–¹æ³•éƒ½åŒ…å«å®Œæ•´çš„ try-catch å¼‚å¸¸å¤„ç†ï¼š
```java
try {
    // æµ‹è¯•é€»è¾‘
} catch (Exception e) {
    String errorMsg = "æµ‹è¯•æ–¹æ³• xxx æ‰§è¡Œå¤±è´¥";
    System.err.println(errorMsg + ": " + e.getMessage());
    e.printStackTrace();
    return "{\"error\": \"" + errorMsg + "\", \"exception\": \"" + e.getClass().getName() + "\", \"message\": \"" + e.getMessage().replace("\"", "'") + "\"}";
}
```

### 2. **URL å‘½åè§„èŒƒ**
- ä½¿ç”¨ camelCase å‘½å
- æ ¼å¼: `test{MethodName}{ConditionDesc}`
- ä¾‹å¦‚: `testGetNoticeHistoryDefaultOrder`

### 3. **å‚æ•°ç¡¬ç¼–ç **
- æ‰€æœ‰æµ‹è¯•å‚æ•°å†™æ­»åœ¨æ–¹æ³•å†…éƒ¨
- æ–¹ä¾¿é€šè¿‡ Postman ç›´æ¥è°ƒç”¨ï¼Œæ— éœ€ä¼ å‚
- ä¾¿äºå¿«é€ŸéªŒè¯åŠŸèƒ½

### 4. **æ—¥å¿—è¾“å‡º**
æ¯ä¸ªæµ‹è¯•æ–¹æ³•éƒ½åŒ…å«ï¼š
- æµ‹è¯•å¼€å§‹æ—¥å¿—: `System.out.println("æµ‹è¯•: æ–¹æ³•å - æ¡ä»¶è¯´æ˜")`
- æµ‹è¯•ç»“æœæ—¥å¿—: `System.out.println("ç»“æœ: ...")`
- é”™è¯¯æ—¥å¿—: `System.err.println(...)` + `e.printStackTrace()`

---

## æµ‹è¯•è¦†ç›–çš„ MyBatis æ¡ä»¶è¯­å¥

### `<choose>` / `<when>` / `<otherwise>`
ç”¨äºå¤šåˆ†æ”¯æ¡ä»¶é€‰æ‹©ï¼Œç±»ä¼¼ Java çš„ switch-caseï¼š

#### ç¤ºä¾‹ 1: æ’åºæ¡ä»¶
```xml
<choose>
    <when test="orderByStr == null or orderByStr == ''">
        tnh.contact_at desc  -- é»˜è®¤æ’åº
    </when>
    <otherwise>
        ${orderByStr}  -- è‡ªå®šä¹‰æ’åº
    </otherwise>
</choose>
```

#### ç¤ºä¾‹ 2: æšä¸¾æ˜ å°„
```xml
<choose>
    <when test="item == 'in'">
        direction = 1  -- å…¥å‘
    </when>
    <when test="item == 'out'">
        direction = 2  -- å‡ºå‘
    </when>
    <otherwise>
        direction = 3  -- åŒå‘
    </otherwise>
</choose>
```

#### ç¤ºä¾‹ 3: è¡¨é€‰æ‹©
```xml
<choose>
    <when test="prohibitDomain">
        t_prohibit_domain_history  -- åŸŸåå°ç¦è¡¨
    </when>
    <when test="prohibitDomain == null or prohibitDomain == false">
        t_prohibit_history  -- IPå°ç¦è¡¨
    </when>
    <otherwise>
        t_prohibit_history  -- é»˜è®¤IPè¡¨
    </otherwise>
</choose>
```

---

## ä½¿ç”¨ Postman æµ‹è¯•æŒ‡å—

### æµ‹è¯•æ­¥éª¤:
1. **å¯åŠ¨åº”ç”¨**: ç¡®ä¿ Spring Boot åº”ç”¨å·²å¯åŠ¨
2. **æ‰§è¡Œæµ‹è¯•SQL**: è¿è¡Œå¯¹åº”æ¨¡å—çš„ `test_data.sql`
3. **è°ƒç”¨æµ‹è¯•æ¥å£**: ä½¿ç”¨ Postman GET è¯·æ±‚

### ç¤ºä¾‹è¯·æ±‚:

```http
GET http://localhost:8080/test/noticeHistory/testGetNoticeHistoryDefaultOrder
```

### é¢„æœŸå“åº”:
```
SUCCESS: 5
```

### é”™è¯¯å“åº”ç¤ºä¾‹:
```json
{
  "error": "æµ‹è¯•æ–¹æ³• testGetNoticeHistoryDefaultOrder æ‰§è¡Œå¤±è´¥",
  "exception": "org.mybatis.spring.MyBatisSystemException",
  "message": "Error querying database..."
}
```

---

## å‰©ä½™å·¥ä½œ

### ç¬¬äºŒé˜¶æ®µï¼šä¸­ä¼˜å…ˆçº§æ¨¡å—ï¼ˆå¾…å¼€å§‹ï¼‰
1. **LinkedStrategy** - å¤šæ¡ä»¶æŸ¥è¯¢æµ‹è¯•
   - `getLinkStrategyList` - source/linkDeviceType/linkDeviceIp æ¡ä»¶
   - `getLinkStrategyByIds` - strategyIds ä¸ºç©º/ä¸ä¸ºç©º

2. **ScanHistoryDetail** - å¤šå‚æ•°æ¡ä»¶æµ‹è¯•
   - `selectByOption` - å¤šä¸ªå¯é€‰å‚æ•°ç»„åˆ
   - `selectScanIps` - åŒä¸Š

### ç¬¬ä¸‰é˜¶æ®µï¼šä½ä¼˜å…ˆçº§ï¼ˆéªŒè¯ç°æœ‰æµ‹è¯•ï¼‰
- éªŒè¯åŠ¨æ€å­—æ®µæ„å»ºçš„ `<if>` æ¡ä»¶æ˜¯å¦å·²è¢«ç°æœ‰æµ‹è¯•è¦†ç›–
- ä¸»è¦é’ˆå¯¹ `insert` / `update` / `batchInsertOrUpdate` æ–¹æ³•

---

## è´¨é‡ä¿è¯

### âœ… å·²å®ç°:
- [x] æ‰€æœ‰æµ‹è¯•æ–¹æ³•åŒ…å« try-catch å¼‚å¸¸å¤„ç†
- [x] æ‰€æœ‰æµ‹è¯•æ–¹æ³•è¾“å‡ºè¯¦ç»†æ—¥å¿—
- [x] URL ä½¿ç”¨ camelCase å‘½å
- [x] å‚æ•°ç¡¬ç¼–ç ï¼Œæ–¹ä¾¿æµ‹è¯•
- [x] è¦†ç›–æ‰€æœ‰ `<choose>` æ¡ä»¶åˆ†æ”¯
- [x] é”™è¯¯ä¿¡æ¯ä»¥ JSON æ ¼å¼è¿”å›

### âš ï¸ æ³¨æ„äº‹é¡¹:
1. **è·¨åº“æŸ¥è¯¢**: ThirdAuth ä½¿ç”¨äº† `bigdata_web.t_third_auth`ï¼Œéœ€è¦é…ç½®è·¨åº“è®¿é—®æˆ– FDW
2. **æµ‹è¯•æ•°æ®**: éƒ¨åˆ†æµ‹è¯•ä¾èµ– `test_data.sql` ä¸­çš„æ•°æ®
3. **å‚æ•°ç±»å‹**: ç¡®ä¿ Mapper æ¥å£çš„å‚æ•°ç±»å‹ä¸ XML ä¸­çš„ test æ¡ä»¶åŒ¹é…

---

## æ€»ç»“

âœ… **ç¬¬ä¸€é˜¶æ®µå®Œæˆ**  
- 6 ä¸ªé«˜ä¼˜å…ˆçº§æ¨¡å—
- 25 ä¸ªæ–°æµ‹è¯•æ–¹æ³•
- è¦†ç›–æ‰€æœ‰å…³é”®çš„ `<choose>`/`<when>` æ¡ä»¶åˆ†æ”¯
- æ‰€æœ‰æ–¹æ³•åŒ…å«å®Œæ•´çš„å¼‚å¸¸å¤„ç†å’Œæ—¥å¿—è¾“å‡º

ğŸ¯ **ä¸‹ä¸€æ­¥**  
- æ‰§è¡Œç¬¬äºŒé˜¶æ®µï¼šä¸­ä¼˜å…ˆçº§æ¨¡å—çš„æ¡ä»¶æµ‹è¯•
- æˆ–è€…ï¼šå¼€å§‹éªŒè¯ç°æœ‰æµ‹è¯•çš„è¦†ç›–æƒ…å†µ

---

**ç”Ÿæˆæ—¶é—´**: 2026-01-28  
**çŠ¶æ€**: âœ… ç¬¬ä¸€é˜¶æ®µå®Œæˆ
