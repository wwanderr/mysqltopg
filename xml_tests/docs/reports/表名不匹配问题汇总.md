# 表名不匹配问题汇总报告

**检查时间**: 2026-01-28  
**检查范围**: 所有 xml_tests 模块  
**严重程度**: ⚠️ 高 - 导致测试完全无法运行

---

## 📋 执行摘要

通过一一比对 `test_data.sql` 和 `XML Mapper` 中的表名，发现：

- **检查模块**: 38 个
- **✅ 通过**: 5 个 (13%)
- **❌ 有问题**: 31 个 (82%)
- **⚠️ 缺失**: 2 个 (5%)

**结论**: **大量模块的测试数据无法正常执行**！

---

## ✅ 通过检查的模块 (5个)

| 模块 | 表名 | 状态 |
|------|------|------|
| AssetInfo | `t_asset_info` | ✅ 正确 |
| AttackerTrafficTask | `t_attacker_traffic_task` | ✅ 正确 |
| **IsolationHistory** | `t_isolation_history` | ✅ **已修复** |
| **KillProcessHistory** | `t_process_kill_history` | ✅ **已修复** |
| VirusKillHistory | `t_virus_kill_history` | ✅ 正确 |
| NoticeHistory | `t_notice_history`, `t_linked_strategy` | ✅ 正确 |

---

## 🚨 高优先级问题（表名完全错误）

### 1. LinkedStrategyValidtime
- **test_data.sql**: `t_linked_strategy_validtime`
- **XML Mapper**: `t_linkage_strategy_validtime`
- **问题**: `linked` vs `linkage`
- **影响**: 所有插入/查询失败

### 2. LoginBaseline
- **test_data.sql**: `t_login_baseline`
- **XML Mapper**: `t_scene_login_baseline`
- **问题**: 缺少 `scene_` 前缀
- **影响**: 所有操作失败

### 3. RiskIncidentHistory
- **test_data.sql**: `t_risk_incident_history`
- **XML Mapper**: `t_risk_incidents_history`
- **问题**: `incident` vs `incidents` (单复数)
- **影响**: 所有操作失败

### 4. ScenarioData
- **test_data.sql**: `t_scenario_data`
- **XML Mapper**: `t_event_scenario_data`
- **问题**: 缺少 `event_` 前缀
- **影响**: 所有操作失败

### 5. ScenarioTemplate
- **test_data.sql**: `t_scenario_template`
- **XML Mapper**: `t_event_scenario_template`
- **问题**: 缺少 `event_` 前缀
- **影响**: 所有操作失败

### 6. SecurityType
- **test_data.sql**: `t_security_type`
- **XML Mapper**: `t_security_types`
- **问题**: 单数 vs 复数
- **影响**: 所有操作失败

### 7. SharedData
- **test_data.sql**: `t_shared_data`
- **XML Mapper**: `t_security_incidents`
- **问题**: 完全不同的表名！
- **影响**: 严重 - 表名完全错误

### 8. TagSearch
- **test_data.sql**: `t_tag_search`
- **XML Mapper**: `t_tag_search_list`
- **问题**: 缺少 `_list` 后缀
- **影响**: 所有操作失败

### 9. SecurityZoneSync
- **test_data.sql**: `t_security_zone_sync`
- **XML Mapper**: 跨库查询 `bigdata_web`
- **问题**: 跨数据库查询
- **影响**: 需要FDW配置

---

## ⚠️ 中优先级问题（可能涉及多表）

以下模块在 XML Mapper 中使用了多个表，需要仔细核对：

### 1. Intelligence
- **test_data.sql**: (待检查)
- **XML Mapper 涉及表**:
  - `t_intelligence_sub` (主表)
  - `t_intelligence_sub_asset`
  - `t_ailpha_security_zone` (FDW)
  - `t_ailpha_network_segment` (FDW)
  - `t_asset_info` (FDW)

### 2. ProhibitHistory
- **XML Mapper 涉及表**:
  - `t_prohibit_history` (主表)
  - `t_prohibit_domain_history`
  - `t_strategy_device_rel`

### 3. RiskIncident / RiskIncidentHistory / RiskIncidentOutGoing
这几个模块相互关联，涉及表：
- `t_risk_incidents`
- `t_risk_incidents_history`
- `t_risk_incidents_out_going`
- `t_risk_incidents_out_going_history`
- `t_risk_incidents_analysis`
- `t_security_incidents`
- `t_alarm_status_timing_task`

### 4. OutGoingConfig
- **XML Mapper 涉及表**:
  - `t_alarm_out_going_config`
  - `t_event_out_going_config`
  - `t_risk_out_going_config`

---

## 📝 脚本误报分析

检测脚本可能将以下内容误识别为表名：
- `SET` (UPDATE 语句关键字)
- `id` (字段名)
- `bigdata_web` (数据库名)

**实际问题数量可能少于31个**，但上述9个高优先级问题**确实存在**。

---

## 🔧 修复建议

### 修复优先级

#### 第一优先级（表名完全错误，立即修复）
1. ✅ **IsolationHistory** - 已修复
2. ✅ **KillProcessHistory** - 已修复
3. ❌ **LinkedStrategyValidtime**
4. ❌ **LoginBaseline**
5. ❌ **RiskIncidentHistory**
6. ❌ **ScenarioData**
7. ❌ **ScenarioTemplate**
8. ❌ **SecurityType**
9. ❌ **SharedData**
10. ❌ **TagSearch**

#### 第二优先级（跨库/多表，需要仔细核对）
- Intelligence
- ProhibitHistory
- RiskIncident 系列
- OutGoingConfig

### 修复步骤

对于每个有问题的模块：

```bash
# 1. 查看 XML Mapper 确认表名
cat postgresql_xml_manual/{模块名}Mapper.xml | grep "INSERT INTO\|FROM"

# 2. 查看建表SQL确认表结构
ls create_table/migrations_ultimate/*{表名}*.sql

# 3. 修改 test_data.sql
# 4. 修改 Controller (如果有字段不匹配)
# 5. 更新快速开始文档
```

---

## 📊 统计分析

### 表名不匹配类型

| 问题类型 | 数量 | 示例 |
|---------|------|------|
| 缺少前缀/后缀 | 4 | `t_scenario_data` → `t_event_scenario_data` |
| 单复数错误 | 2 | `t_security_type` → `t_security_types` |
| 单词拼写差异 | 1 | `t_linked_strategy_validtime` → `t_linkage_strategy_validtime` |
| 完全不同的表 | 1 | `t_shared_data` → `t_security_incidents` |
| 跨库查询 | 1 | `bigdata_web.*` |

### 根本原因分析

1. **未核对 XML Mapper**: 测试数据编写者**没有查看** XML Mapper 中的实际表名
2. **凭印象命名**: 根据模块名称"推测"表名，未验证
3. **单复数不一致**: MySQL 到 PostgreSQL 迁移过程中表名调整
4. **前缀变更**: 部分表添加了 `event_`, `scene_` 等前缀

---

## ✅ 最佳实践

### 正确的测试数据编写流程

```
1. 📖 打开 {模块}Mapper.xml
   └─> 查找 <insert>, <select>, <update>, <delete> 标签
   └─> 记录所有表名

2. 📖 打开建表SQL (create_table/migrations_ultimate/)
   └─> 确认表结构和字段名称
   └─> 特别注意枚举类型

3. 📝 编写 test_data.sql
   └─> 使用正确的表名
   └─> 使用正确的字段名
   └─> 使用正确的枚举值

4. 🧪 验证测试
   └─> psql 执行 test_data.sql
   └─> 确认数据插入成功

5. 📄 更新文档
   └─> 快速开始.md
   └─> Controller 注释
```

---

## 🎯 后续行动

### 立即行动
1. 修复 **9 个高优先级模块** 的表名
2. 生成每个模块的修复报告
3. 更新相应的 Controller 和文档

### 计划行动
1. 核对所有多表模块
2. 处理跨库查询模块（需要FDW配置）
3. 生成完整的测试验证报告

---

**生成时间**: 2026-01-28  
**检查工具**: `check_table_names.py`  
**状态**: 问题已识别，等待修复
