package com.test.controller;

import com.dbapp.extension.xdr.linkageHandle.mapper.LinkedStrategyValidtimeMapper;
import com.dbapp.extension.xdr.linkageHandle.entity.EndTimeEntity;
import com.dbapp.extension.xdr.linkageHandle.entity.ProhibitHistory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.*;

import java.time.LocalDateTime;
import java.time.format.DateTimeFormatter;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

/**
 * LinkedStrategyValidtime 测试 Controller
 * 
 * 所有测试方法使用 GET 请求，参数在方法内部写死
 * 通过 Postman 调用 http://localhost:8080/test/linkedStrategyValidtime/testX_methodName
 * 
 * 测试数据：使用test_data.sql中的测试数据
 * 
 * 生成时间: 2026-01-26
 */
@RestController
@RequestMapping("/test/linkedStrategyValidtime")
public class LinkedStrategyValidtimeTestController {
    
    @Autowired
    private LinkedStrategyValidtimeMapper mapper;

    /**
     * 测试1：插入有效时间
     * URL: /test/linkedStrategyValidtime/insertValidtime
     */
    @GetMapping("/insertValidtime")
    public String testInsertValidtime() {
        System.out.println("测试: insertValidtime");
        
        ProhibitHistory history = new ProhibitHistory();
        history.setLinkDeviceIp("192.168.1.10");
        history.setBlockIp("10.0.0.100");
        history.setNodeId("node-001");
        history.setDirection("src");
        history.setEffectTime(LocalDateTime.now().format(DateTimeFormatter.ofPattern("yyyy-MM-dd HH:mm:ss")));
        
        String endTime = LocalDateTime.now().plusHours(24).format(DateTimeFormatter.ofPattern("yyyy-MM-dd HH:mm:ss"));
        
        int rows = mapper.insertValidtime(history, endTime);
        System.out.println("结果: 影响 " + rows + " 行");
        return "SUCCESS: " + rows + " 条";
    }

    /**
     * 测试2：删除有效时间
     * URL: /test/linkedStrategyValidtime/deleteEndtime
     */
    @GetMapping("/deleteEndtime")
    public String testDeleteEndtime() {
        System.out.println("测试: deleteEndtime");
        
        Map<String, Object> params = new HashMap<>();
        params.put("linkDeviceIp", "192.168.1.10");
        params.put("blockIp", "10.0.0.100");
        params.put("direction", "src");
        
        int rows = mapper.deleteEndtime(params);
        System.out.println("结果: 删除 " + rows + " 条");
        return "SUCCESS: 删除 " + rows + " 条";
    }

    /**
     * 测试3：查询过期的有效时间记录
     * URL: /test/linkedStrategyValidtime/selectEndTime
     */
    @GetMapping("/selectEndTime")
    public String testSelectEndTime() {
        System.out.println("测试: selectEndTime");
        
        String nowTime = LocalDateTime.now().format(DateTimeFormatter.ofPattern("yyyy-MM-dd HH:mm:ss"));
        
        List<EndTimeEntity> result = mapper.selectEndTime(nowTime);
        System.out.println("结果: 查询到 " + result.size() + " 条过期记录");
        return "SUCCESS: " + result.size() + " 条";
    }
}
