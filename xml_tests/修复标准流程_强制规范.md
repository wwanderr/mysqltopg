# 测试单元修复标准流程（强制规范）

**制定时间**: 2026-01-28  
**适用范围**: 所有后续xml_tests模块修复

---

## 🔴 强制修复顺序

### ⚠️ 必须严格遵守的顺序：

```
第一步：修复 test_data.sql
    ↓
第二步：修复 TestController.java
```

**禁止反向操作！** 不允许先修复Controller再修复SQL！

---

## 📋 详细修复流程

### 第一步：修复 test_data.sql

#### 1.1 检查DDL文件
```bash
目标文件: create_table/migrations_ultimate/V*__create_t_*.sql
检查内容: 表结构、字段名、字段类型、注释
```

#### 1.2 检查XML Mapper
```bash
目标文件: postgresql_xml_manual/*Mapper.xml
检查内容: 
  - 表名是否匹配DDL
  - 涉及的关联表（LEFT JOIN、INNER JOIN）
  - 条件参数（<if>、<choose>、<when>）
```

#### 1.3 编写test_data.sql
```sql
-- 必须包含的内容：
1. 主表数据（至少10条）
   - 覆盖所有字段
   - 覆盖所有ENUM类型
   - 覆盖High/Medium/Low等级
   - 覆盖各种状态值

2. 关联表数据（至少3-5条/表）
   - 根据XML Mapper的JOIN语句
   - 确保外键关联正确

3. 验证SQL（可选）
   - 统计查询
   - 分组查询
```

#### 1.4 验证test_data.sql
- ✅ 字段名100%匹配DDL
- ✅ 字段类型正确
- ✅ 关联表数据完整
- ✅ 数据场景覆盖全面

---

### 第二步：修复 TestController.java

#### 2.1 分析XML Mapper方法
```java
统计信息：
- 总方法数: ?
- SELECT方法: ?
- INSERT方法: ?
- UPDATE方法: ?
- DELETE方法: ?
```

#### 2.2 编写测试方法
```java
要求：
1. 一个XML方法 = 一个测试方法
2. 所有参数在一个测试方法中
3. 100%异常处理（try-catch）
4. 完整日志输出

模板：
@GetMapping("/testXxx")
public String testXxx() {
    try {
        System.out.println("测试: xxx - 说明");
        Map<String, Object> params = new HashMap<>();
        
        // 测试所有<if>条件参数
        params.put("param1", value1);
        params.put("param2", value2);
        // ... 所有参数
        
        // 调用Mapper方法
        Object result = mapper.xxx(params);
        
        System.out.println("结果: " + result);
        return "SUCCESS: " + result;
    } catch (Exception e) {
        String errorMsg = "测试方法 testXxx 执行失败";
        System.err.println(errorMsg + ": " + e.getMessage());
        e.printStackTrace();
        return "{\"error\": \"" + errorMsg + "\", \"exception\": \"" + e.getClass().getName() + "\", \"message\": \"" + e.getMessage().replace("\"", "'") + "\"}";
    }
}
```

#### 2.3 参数覆盖要求
```java
必须测试的参数：
✅ 所有<if test="param != null">中的param
✅ 所有<choose><when test="param">中的param
✅ 所有<foreach collection="list">中的list
✅ 分页参数（pageNum、pageSize、offset、limit）
✅ 排序参数（orderByStr、order）
✅ 时间参数（startTime、endTime）
```

#### 2.4 验证TestController
- ✅ 方法数与XML Mapper方法数一致
- ✅ 每个方法都有try-catch
- ✅ 参数覆盖率>90%
- ✅ 测试场景数≥10个

---

## ✅ 修复完成标志

### 必须满足的条件：

1. **test_data.sql**
   - [ ] 字段100%匹配DDL
   - [ ] 关联表数据完整（2-4张表）
   - [ ] 测试数据≥10条
   - [ ] 数据场景覆盖全面

2. **TestController.java**
   - [ ] 异常处理100%覆盖
   - [ ] 参数覆盖率>90%
   - [ ] 测试方法数 = XML方法数
   - [ ] 每个方法有完整日志

3. **生成报告**
   - [ ] 创建 `模块名/深度修复报告.md`
   - [ ] 列出修复前后对比
   - [ ] 列出核心测试场景

---

## 📊 质量标准

| 项目 | 最低标准 | 推荐标准 |
|------|----------|----------|
| **字段覆盖率** | 80% | 100% |
| **参数测试数** | 5个/方法 | 8-11个/方法 |
| **测试场景数** | 10个 | 15-20个 |
| **异常处理** | 100% | 100% |
| **关联表数** | 1张 | 2-4张 |
| **IF条件覆盖** | 70% | 95%+ |

---

## 🚫 常见错误（禁止）

### ❌ 错误做法1：先修复Controller
```
❌ 先写TestController.java
❌ 后发现test_data.sql字段不对
❌ 需要重新修改Controller
结果：浪费时间，容易出错
```

### ❌ 错误做法2：test_data.sql字段不对齐
```
❌ test_data.sql使用错误字段名
❌ 与DDL不一致
结果：Controller运行时报错，需要重新修复
```

### ❌ 错误做法3：缺少关联表数据
```
❌ 只插入主表数据
❌ 忘记XML Mapper的JOIN表
结果：查询返回空结果，测试失败
```

### ❌ 错误做法4：参数覆盖不全
```
❌ 只测试部分参数
❌ 忽略<if>、<choose>分支
结果：代码逻辑未完全验证
```

---

## ✅ 正确示例

### 示例1：RiskIncident修复流程
```
Step 1: 读取 V*__create_t_risk_incidents.sql
        ↓
Step 2: 读取 RiskIncidentMapper.xml
        ↓ 发现30个方法，涉及3张关联表
Step 3: 编写 test_data.sql
        - t_risk_incidents: 10条，24字段
        - t_event_template: 5条
        - t_query_template: 5条
        - t_security_incidents: 5条
        ↓
Step 4: 验证 test_data.sql 字段对齐
        ↓
Step 5: 编写 RiskIncidentTestController.java
        - 30个测试方法
        - 100%异常处理
        - getRiskList: 11个参数全覆盖
        ↓
Step 6: 生成 深度修复报告.md
```

---

## 📝 修复报告模板

```markdown
# [模块名] 深度修复报告

## 📊 模块信息
- **主表**: t_xxx (N个字段)
- **关联表**: t_yyy, t_zzz
- **XML方法数**: N个
- **修复时间**: 2026-01-28

## ✅ 修复内容

### 1. test_data.sql 修复
- **修复前**: 字段错误描述
- **修复后**: 完全对齐N个DDL字段
- **测试数据**: 主表N条 + 关联表M条

### 2. TestController 修复
- **方法数**: N个完整测试方法
- **异常处理**: 100%覆盖
- **参数覆盖**: 核心方法参数列表

### 3. 核心测试场景
1. 场景1描述
2. 场景2描述
...

## 📈 质量对比
| 维度 | 修复前 | 修复后 |
|------|--------|--------|
| 字段覆盖率 | X% | 100% |
| 参数测试 | N个 | M个 |
| 异常处理 | X% | 100% |
```

---

## 🎯 总结

### 核心原则
1. **先SQL后Controller** - 永远不变！
2. **字段100%对齐** - DDL是唯一标准！
3. **全参数覆盖** - 不放过任何<if>分支！
4. **100%异常处理** - 每个方法必有try-catch！

### 执行要点
- ✅ 按顺序执行，不跳步
- ✅ 每步验证通过再进行下一步
- ✅ 修复完成生成报告
- ✅ 质量达标再进入下一个模块
