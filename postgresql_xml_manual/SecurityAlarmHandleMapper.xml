<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.dbapp.extension.xdr.linkageHandle.mapper.SecurityAlarmHandleMapper">

    <!-- 
        注意：ON CONFLICT 需要指定唯一约束列，请根据实际表结构确认冲突列
        示例中假设为 (agg_condition, window_id)，请根据实际情况调整
    -->
    <insert id="insertOrUpdate" parameterType="com.dbapp.extension.xdr.linkageHandle.entity.SecurityAlarmHandle">
        INSERT INTO t_security_alarm_handle
        (agg_condition, window_id,execute_time,handle_status,"result")
        VALUES
        <foreach collection="handleList" item="item" separator=",">
            (
            #{item.aggCondition,jdbcType=VARCHAR},
            #{item.windowId,jdbcType=VARCHAR},
            CAST(#{item.executeTime} AS timestamp),
            #{item.handleStatus,jdbcType=VARCHAR},
            (#{item.result,jdbcType=INTEGER}::int)::boolean
            )
        </foreach>
        ON CONFLICT (agg_condition, window_id) DO UPDATE SET execute_time = EXCLUDED.execute_time
    </insert>

    <update id="updateStatusById" parameterType="com.dbapp.extension.xdr.linkageHandle.entity.SecurityAlarmHandle">
        UPDATE t_security_alarm_handle SET "result" = (#{securityAlarmHandle.result,jdbcType=INTEGER}::int)::boolean WHERE id = #{securityAlarmHandle.id}
    </update>
</mapper>
