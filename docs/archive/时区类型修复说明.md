# PostgreSQLæ—¶é—´ç±»å‹ä¿®å¤è¯´æ˜

## âŒ é—®é¢˜æè¿°

### ç°çŠ¶
- **MySQL**: ä½¿ç”¨ `datetime` å’Œ `timestamp` ç±»å‹
- **PostgreSQL DDL**: è½¬æ¢åä½¿ç”¨ `timestamptz` (å¸¦æ—¶åŒº)
- **ç»“æœ**: PostgreSQLå­˜å‚¨æ˜¾ç¤ºä¸º `2024-01-15 14:30:00+08` âŒ

### é—®é¢˜
Javaä»£ç è·å–æ—¶é—´æ—¶ä¼šå¾—åˆ°å¸¦æ—¶åŒºåç¼€çš„å­—ç¬¦ä¸²ï¼Œä¾‹å¦‚ï¼š
```
æœŸæœ›: 2024-01-15 14:30:00
å®é™…: 2024-01-15 14:30:00+08  âŒ
```

---

## ğŸ“Š æ—¶é—´ç±»å‹å¯¹æ¯”

### MySQLæ—¶é—´ç±»å‹

| ç±»å‹ | ç‰¹ç‚¹ | å­˜å‚¨ç¤ºä¾‹ | æ˜¾ç¤ºç¤ºä¾‹ |
|------|------|----------|----------|
| `datetime` | ä¸å¸¦æ—¶åŒºï¼ŒåŸæ ·å­˜å‚¨ | `2024-01-15 14:30:00` | `2024-01-15 14:30:00` |
| `timestamp` | å†…éƒ¨UTCå­˜å‚¨ï¼Œæœ¬åœ°æ—¶åŒºæ˜¾ç¤º | UTCæ—¶é—´ | `2024-01-15 14:30:00` |

### PostgreSQLæ—¶é—´ç±»å‹

| ç±»å‹ | ç‰¹ç‚¹ | å­˜å‚¨ç¤ºä¾‹ | æ˜¾ç¤ºç¤ºä¾‹ | Javaè·å– |
|------|------|----------|----------|----------|
| `timestamptz` | å¸¦æ—¶åŒºï¼ŒUTCå­˜å‚¨ | UTC | `2024-01-15 14:30:00+08` | `2024-01-15 14:30:00+08` âŒ |
| `timestamp` | ä¸å¸¦æ—¶åŒºï¼ŒåŸæ ·å­˜å‚¨ | `2024-01-15 14:30:00` | `2024-01-15 14:30:00` | `2024-01-15 14:30:00` âœ… |

**ç»“è®º**: è¦å¯¹é½MySQLçš„è¡Œä¸ºï¼Œåº”è¯¥ä½¿ç”¨ `timestamp` è€Œä¸æ˜¯ `timestamptz`

---

## âœ… è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆ1: ä¿®æ”¹DDLï¼ˆæ¨èï¼‰â­â­â­â­â­

**æ“ä½œ**: æ‰¹é‡æ›¿æ¢å»ºè¡¨SQLä¸­çš„æ—¶é—´ç±»å‹

```sql
-- ä¿®æ”¹å‰
CREATE TABLE t_alarm_out_going_config (
    id int8,
    create_time timestamptz(6),  âŒ
    update_time timestamptz(6)   âŒ
);

-- ä¿®æ”¹å
CREATE TABLE t_alarm_out_going_config (
    id int8,
    create_time timestamp(6),    âœ…
    update_time timestamp(6)     âœ…
);
```

**ä¼˜ç‚¹**:
- âœ… å®Œå…¨å¯¹é½MySQLè¯­ä¹‰
- âœ… Javaä»£ç æ— éœ€ä¿®æ”¹
- âœ… MyBatis XMLæ— éœ€ä¿®æ”¹
- âœ… ä¸€æ¬¡æ€§è§£å†³æ‰€æœ‰é—®é¢˜

**å½±å“èŒƒå›´**:
- 47ä¸ªSQLæ–‡ä»¶
- 133å¤„ `timestamptz` éœ€è¦æ›¿æ¢

---

### æ–¹æ¡ˆ2: MyBatis XMLæ ¼å¼åŒ–

**åœ¨SELECTè¯­å¥ä¸­æ ¼å¼åŒ–æ—¶é—´å­—æ®µ**

```xml
<!-- ä¿®æ”¹å‰ -->
<select id="selectList" resultMap="baseResult">
    SELECT id, create_time, update_time FROM t_alarm_out_going_config
</select>

<!-- ä¿®æ”¹å -->
<select id="selectList" resultMap="baseResult">
    SELECT 
        id, 
        TO_CHAR(create_time, 'YYYY-MM-DD HH24:MI:SS') as create_time,
        TO_CHAR(update_time, 'YYYY-MM-DD HH24:MI:SS') as update_time
    FROM t_alarm_out_going_config
</select>
```

**ç¼ºç‚¹**:
- âŒ éœ€è¦ä¿®æ”¹æ‰€æœ‰XMLæ–‡ä»¶çš„SELECTè¯­å¥
- âŒ ç»´æŠ¤æˆæœ¬é«˜
- âŒ å®¹æ˜“é—æ¼

**é€‚ç”¨åœºæ™¯**:
- DDLå·²ç»éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒï¼Œæ— æ³•ä¿®æ”¹
- ä¸´æ—¶è§£å†³æ–¹æ¡ˆ

---

### æ–¹æ¡ˆ3: Javaå®ä½“ç±»ä½¿ç”¨`LocalDateTime`ï¼ˆå»ºè®®é…åˆæ–¹æ¡ˆ1ï¼‰â­â­â­â­

**Javaå®ä½“ç±»ä¿®æ”¹**

```java
// ä¿®æ”¹å‰ï¼ˆé”™è¯¯ï¼‰
import java.util.Date;

public class AlarmOutGoingConfig {
    private Date createTime;   // Dateç±»å‹ä¼šä¿ç•™æ—¶åŒºä¿¡æ¯
    private Date updateTime;
}

// ä¿®æ”¹åï¼ˆæ­£ç¡®ï¼‰
import java.time.LocalDateTime;

public class AlarmOutGoingConfig {
    private LocalDateTime createTime;   // LocalDateTimeè‡ªåŠ¨å»é™¤æ—¶åŒº
    private LocalDateTime updateTime;
}
```

**æ•ˆæœ**:
- âœ… `LocalDateTime` ä¸åŒ…å«æ—¶åŒºä¿¡æ¯
- âœ… JDBCè‡ªåŠ¨å°† `timestamptz` è½¬æ¢ä¸º `LocalDateTime` æ—¶ä¼šå»é™¤æ—¶åŒº
- âœ… ä»£ç æ›´åŠ ç°ä»£åŒ–ï¼ˆJava 8+ï¼‰

**è·å–åˆ°çš„å€¼**:
```java
// timestamptz(6) å­˜å‚¨: 2024-01-15 14:30:00+08
// Java LocalDateTime è·å–: 2024-01-15T14:30:00  âœ… (æ— æ—¶åŒºåç¼€)

// timestamp(6) å­˜å‚¨: 2024-01-15 14:30:00
// Java LocalDateTime è·å–: 2024-01-15T14:30:00  âœ…
```

---

## ğŸ¯ æ¨èæ–¹æ¡ˆç»„åˆ

### **æ–¹æ¡ˆ1 (DDLä¿®æ”¹) + æ–¹æ¡ˆ3 (Java LocalDateTime)**

1. **ç¬¬ä¸€æ­¥**: æ‰¹é‡ä¿®æ”¹DDLï¼Œ`timestamptz` â†’ `timestamp`
2. **ç¬¬äºŒæ­¥**: Javaå®ä½“ç±»ä½¿ç”¨ `LocalDateTime`
3. **ç¬¬ä¸‰æ­¥**: MyBatis XMLæ— éœ€ä¿®æ”¹

**æœ€ç»ˆæ•ˆæœ**:
- âœ… æ•°æ®åº“å­˜å‚¨: `2024-01-15 14:30:00`
- âœ… Javaè·å–: `2024-01-15T14:30:00`
- âœ… å®Œå…¨å¯¹é½MySQLè¡Œä¸º

---

## ğŸ› ï¸ æ‰¹é‡ä¿®å¤å·¥å…·

### ä½¿ç”¨æ–¹æ³•

1. **è¿è¡Œä¿®å¤è„šæœ¬**:
```bash
python fix_timestamptz_to_timestamp.py
```

2. **è„šæœ¬åŠŸèƒ½**:
   - æ‰«æ `create_table/migrations_ultimate` ç›®å½•
   - æ‰¹é‡æ›¿æ¢æ‰€æœ‰ `timestamptz` â†’ `timestamp`
   - è‡ªåŠ¨å¤‡ä»½åŸå§‹æ–‡ä»¶ï¼ˆå¯é€‰ï¼‰

3. **ä¿®æ”¹å†…å®¹**:
   - `timestamptz(6)` â†’ `timestamp(6)`
   - `timestamptz` â†’ `timestamp`
   - `TIMESTAMPTZ(6)` â†’ `TIMESTAMP(6)`
   - `TIMESTAMPTZ` â†’ `TIMESTAMP`

---

## ğŸ“‹ å½±å“èŒƒå›´ç»Ÿè®¡

### DDLæ–‡ä»¶
- **æ€»æ–‡ä»¶æ•°**: 47ä¸ª
- **å—å½±å“æ–‡ä»¶**: 47ä¸ª
- **æ€»æ›¿æ¢å¤„**: 133å¤„

### ä¸»è¦æ¶‰åŠçš„è¡¨
- `t_alarm_out_going_config`: 3å¤„
- `t_alarm_status_timing_task`: 2å¤„
- `t_event_out_going_config`: 3å¤„
- `t_event_out_going_data`: 6å¤„
- `t_security_incidents`: 6å¤„
- `t_risk_incidents`: 6å¤„
- ... (å…±47ä¸ªè¡¨)

### MyBatis XMLæ–‡ä»¶
- **æ— éœ€ä¿®æ”¹** (å¦‚æœä½¿ç”¨æ–¹æ¡ˆ1)
- **æˆ–éœ€ä¿®æ”¹**: 40ä¸ªæ–‡ä»¶ï¼ˆå¦‚æœä½¿ç”¨æ–¹æ¡ˆ2ï¼‰

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. æ—¶åŒºè¡Œä¸ºå˜åŒ–

**`timestamptz` (ä¿®æ”¹å‰)**:
- æ’å…¥: `INSERT INTO t (time) VALUES ('2024-01-15 14:30:00')` 
- å­˜å‚¨: UTCæ—¶é—´ (å¦‚æœå®¢æˆ·ç«¯æ˜¯+08ï¼Œä¼šå­˜ä¸º `2024-01-15 06:30:00 UTC`)
- æŸ¥è¯¢: æ˜¾ç¤ºä¸ºå®¢æˆ·ç«¯æ—¶åŒº `2024-01-15 14:30:00+08`

**`timestamp` (ä¿®æ”¹å)**:
- æ’å…¥: `INSERT INTO t (time) VALUES ('2024-01-15 14:30:00')`
- å­˜å‚¨: åŸæ ·å­˜å‚¨ `2024-01-15 14:30:00`
- æŸ¥è¯¢: åŸæ ·è¿”å› `2024-01-15 14:30:00`

**å»ºè®®**: åœ¨åº”ç”¨å±‚ç»Ÿä¸€ä½¿ç”¨æœåŠ¡å™¨æœ¬åœ°æ—¶åŒºï¼ˆå¦‚ Asia/Shanghaiï¼‰ï¼Œé¿å…æ—¶åŒºæ··æ·†ã€‚

---

### 2. å·²æœ‰æ•°æ®è¿ç§»

å¦‚æœè¡¨å·²ç»åˆ›å»ºå¹¶æœ‰æ•°æ®ï¼Œéœ€è¦æ‰§è¡Œç±»å‹è½¬æ¢ï¼š

```sql
-- ä¿®æ”¹åˆ—ç±»å‹
ALTER TABLE t_alarm_out_going_config 
ALTER COLUMN create_time TYPE timestamp(6);

ALTER TABLE t_alarm_out_going_config 
ALTER COLUMN update_time TYPE timestamp(6);

-- æ‰¹é‡ä¿®æ”¹æ‰€æœ‰è¡¨ï¼ˆç”Ÿæˆè„šæœ¬ï¼‰
SELECT 
    'ALTER TABLE ' || table_name || 
    ' ALTER COLUMN ' || column_name || 
    ' TYPE timestamp(6);' as sql_statement
FROM information_schema.columns
WHERE table_schema = 'public'
  AND data_type = 'timestamp with time zone';
```

---

### 3. è¿æ¥æ—¶åŒºè®¾ç½®

**JDBCè¿æ¥å‚æ•°**:
```properties
# æ–¹å¼1: æ˜ç¡®è®¾ç½®æ—¶åŒº
jdbc:postgresql://localhost:5432/dbname?TimeZone=Asia/Shanghai

# æ–¹å¼2: ä¸è®¾ç½®ï¼ˆä½¿ç”¨æœåŠ¡å™¨æ—¶åŒºï¼‰
jdbc:postgresql://localhost:5432/dbname
```

**Spring Booté…ç½®**:
```yaml
spring:
  datasource:
    url: jdbc:postgresql://localhost:5432/dbname?TimeZone=Asia/Shanghai
  jpa:
    properties:
      hibernate:
        jdbc:
          time_zone: Asia/Shanghai
```

---

## ğŸ§ª éªŒè¯æ–¹æ³•

### 1. æ•°æ®åº“å±‚éªŒè¯

```sql
-- åˆ›å»ºæµ‹è¯•è¡¨
CREATE TABLE test_time (
    id SERIAL,
    time_with_tz timestamptz(6),
    time_without_tz timestamp(6)
);

-- æ’å…¥æµ‹è¯•æ•°æ®
INSERT INTO test_time (time_with_tz, time_without_tz)
VALUES 
    ('2024-01-15 14:30:00', '2024-01-15 14:30:00');

-- æŸ¥è¯¢å¯¹æ¯”
SELECT 
    time_with_tz,              -- æ˜¾ç¤º: 2024-01-15 14:30:00+08
    time_without_tz            -- æ˜¾ç¤º: 2024-01-15 14:30:00
FROM test_time;

-- æ¸…ç†
DROP TABLE test_time;
```

### 2. Javaä»£ç éªŒè¯

```java
// Entity
@Data
public class AlarmOutGoingConfig {
    private Long id;
    private LocalDateTime createTime;  // ä½¿ç”¨ LocalDateTime
    private LocalDateTime updateTime;
}

// Test
@Test
public void testTimeFormat() {
    AlarmOutGoingConfig config = mapper.selectById(1L);
    
    System.out.println("Create Time: " + config.getCreateTime());
    // æœŸæœ›è¾“å‡º: 2024-01-15T14:30:00 (æ— æ—¶åŒºåç¼€)
    
    // æ ¼å¼åŒ–è¾“å‡º
    DateTimeFormatter formatter = DateTimeFormatter.ofPattern("yyyy-MM-dd HH:mm:ss");
    String formatted = config.getCreateTime().format(formatter);
    System.out.println("Formatted: " + formatted);
    // æœŸæœ›è¾“å‡º: 2024-01-15 14:30:00
}
```

---

## ğŸ“ˆ æ‰§è¡Œè®¡åˆ’

### ç¬¬ä¸€é˜¶æ®µ: DDLä¿®å¤ï¼ˆç«‹å³æ‰§è¡Œï¼‰
1. âœ… è¿è¡Œ `fix_timestamptz_to_timestamp.py`
2. âœ… éªŒè¯ä¿®æ”¹åçš„SQLæ–‡ä»¶
3. âœ… åœ¨æµ‹è¯•ç¯å¢ƒéƒ¨ç½²éªŒè¯

### ç¬¬äºŒé˜¶æ®µ: Javaä»£ç ä¼˜åŒ–ï¼ˆå¯é€‰ï¼‰
1. âšª ä¿®æ”¹Javaå®ä½“ç±»ï¼Œä½¿ç”¨ `LocalDateTime`
2. âšª æ›´æ–° `@Column` æ³¨è§£ï¼ˆå¦‚æœä½¿ç”¨JPAï¼‰
3. âšª æµ‹è¯•æ’å…¥/æŸ¥è¯¢åŠŸèƒ½

### ç¬¬ä¸‰é˜¶æ®µ: ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²
1. âšª å¤‡ä»½ç°æœ‰æ•°æ®åº“
2. âšª æ‰§è¡ŒALTER TABLEè¯­å¥ï¼ˆå¦‚æœè¡¨å·²åˆ›å»ºï¼‰
3. âšª éƒ¨ç½²æ–°çš„Javaä»£ç 
4. âšª éªŒè¯æ—¶é—´æ˜¾ç¤ºæ­£å¸¸

---

## âœ… ä¿®å¤åæ•ˆæœ

### ä¿®æ”¹å‰
```
PostgreSQL:  2024-01-15 14:30:00+08  âŒ
Javaè·å–:    2024-01-15 14:30:00+08  âŒ
```

### ä¿®æ”¹å
```
PostgreSQL:  2024-01-15 14:30:00     âœ…
Javaè·å–:    2024-01-15T14:30:00    âœ…
æ ¼å¼åŒ–è¾“å‡º:   2024-01-15 14:30:00     âœ…
```

---

## ğŸ¯ æ€»ç»“

| æ–¹æ¡ˆ | ä¼˜å…ˆçº§ | ä¿®æ”¹èŒƒå›´ | æ•ˆæœ |
|------|--------|----------|------|
| **æ–¹æ¡ˆ1: DDLä¿®æ”¹** | â­â­â­â­â­ | 47ä¸ªSQLæ–‡ä»¶ | å®Œå…¨è§£å†³ |
| **æ–¹æ¡ˆ2: XMLæ ¼å¼åŒ–** | â­â­ | 40ä¸ªXMLæ–‡ä»¶ | ä¸´æ—¶æ–¹æ¡ˆ |
| **æ–¹æ¡ˆ3: Java LocalDateTime** | â­â­â­â­ | Javaå®ä½“ç±» | é…åˆæ–¹æ¡ˆ1 |

**æœ€ä½³å®è·µ**: æ–¹æ¡ˆ1 + æ–¹æ¡ˆ3
