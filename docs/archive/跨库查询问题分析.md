# PostgreSQL è·¨åº“æŸ¥è¯¢é—®é¢˜åˆ†æ

## ğŸ” é—®é¢˜å‘ç°

åœ¨ XML æ–‡ä»¶ä¸­å‘ç° **è·¨æ•°æ®åº“æŸ¥è¯¢**ï¼Œä½¿ç”¨äº† `bigdata_web` æ•°æ®åº“å‰ç¼€ã€‚

---

## ğŸ“Š å½±å“èŒƒå›´

### æ¶‰åŠçš„æ–‡ä»¶ï¼ˆ3ä¸ªï¼‰

| æ–‡ä»¶ | è·¨åº“è¡¨æ•°é‡ | ä½ç½® |
|------|-----------|------|
| **SecurityZoneSyncMapper.xml** | 3ä¸ªè¡¨ | ç¬¬9, 10, 12è¡Œ |
| **VulAnalysisSubMapper.xml** | 4ä¸ªè¡¨ | å¤šå¤„ï¼ˆ8ä¸ªSQLè¯­å¥ï¼‰ |
| **ThirdAuthMapper.xml** | 1ä¸ªè¡¨ | ç¬¬12è¡Œ |

### æ¶‰åŠçš„è¡¨ï¼ˆ4ä¸ªï¼‰

æ¥è‡ª `bigdata_web` æ•°æ®åº“çš„è¡¨ï¼š
1. `t_asset_info` - èµ„äº§ä¿¡æ¯è¡¨
2. `t_ailpha_network_segment` - ç½‘ç»œæ®µè¡¨
3. `t_ailpha_security_zone` - å®‰å…¨åŒºåŸŸè¡¨
4. `t_vulnerability_info` - æ¼æ´ä¿¡æ¯è¡¨
5. `t_third_auth` - ç¬¬ä¸‰æ–¹è®¤è¯è¡¨

---

## ğŸ”´ MySQL vs PostgreSQL çš„åŒºåˆ«

### MySQL æ”¯æŒ
```sql
-- MySQL å¯ä»¥ç›´æ¥è·¨åº“æŸ¥è¯¢
SELECT * FROM database1.table1 
JOIN database2.table2 ON ...
```

### PostgreSQL é™åˆ¶
```sql
-- PostgreSQL ä¸ç›´æ¥æ”¯æŒè·¨æ•°æ®åº“æŸ¥è¯¢
-- éœ€è¦ç‰¹æ®Šé…ç½®
```

---

## ğŸ’¡ è§£å†³æ–¹æ¡ˆï¼ˆè¯·é€‰æ‹©ä¸€ç§ï¼‰

### æ–¹æ¡ˆ1: Schema æ–¹å¼ï¼ˆæ¨èï¼Œå¦‚æœåœ¨åŒä¸€æ•°æ®åº“ï¼‰â­

**é€‚ç”¨åœºæ™¯**: `bigdata_web` å®é™…ä¸Šæ˜¯åŒä¸€ä¸ª PostgreSQL æ•°æ®åº“ä¸­çš„ä¸€ä¸ª schema

**é…ç½®**:
```sql
-- åœ¨ PostgreSQL ä¸­åˆ›å»º schema
CREATE SCHEMA IF NOT EXISTS bigdata_web;

-- å°†è¡¨åˆ›å»ºåœ¨è¯¥ schema ä¸‹
CREATE TABLE bigdata_web.t_asset_info (...);
CREATE TABLE bigdata_web.t_ailpha_network_segment (...);
CREATE TABLE bigdata_web.t_ailpha_security_zone (...);
CREATE TABLE bigdata_web.t_vulnerability_info (...);
CREATE TABLE bigdata_web.t_third_auth (...);
```

**XML ä¿®æ”¹**:
```xml
<!-- ä¿æŒä¸å˜ï¼Œç»§ç»­ä½¿ç”¨ bigdata_web.table_name -->
<select id="querySecurityZone">
    SELECT ti.assetIp, f."name", f.id
    FROM bigdata_web.t_asset_info ti
    JOIN bigdata_web.t_ailpha_network_segment e ON ...
</select>
```

**ä¼˜ç‚¹**:
- âœ… XML æ— éœ€ä¿®æ”¹ï¼ˆæˆ–ä¿®æ”¹æœ€å°‘ï¼‰
- âœ… æ€§èƒ½æœ€å¥½
- âœ… äº‹åŠ¡æ”¯æŒå®Œæ•´
- âœ… é…ç½®ç®€å•

---

### æ–¹æ¡ˆ2: å¤–éƒ¨æ•°æ®åŒ…è£…å™¨ (FDW)

**é€‚ç”¨åœºæ™¯**: `bigdata_web` æ˜¯å¦ä¸€ä¸ªç‹¬ç«‹çš„ PostgreSQL æ•°æ®åº“

**é…ç½®**:
```sql
-- 1. å®‰è£… postgres_fdw æ‰©å±•
CREATE EXTENSION IF NOT EXISTS postgres_fdw;

-- 2. åˆ›å»ºå¤–éƒ¨æœåŠ¡å™¨
CREATE SERVER bigdata_web_server
FOREIGN DATA WRAPPER postgres_fdw
OPTIONS (host 'bigdata_host', port '5432', dbname 'bigdata_web');

-- 3. åˆ›å»ºç”¨æˆ·æ˜ å°„
CREATE USER MAPPING FOR current_user
SERVER bigdata_web_server
OPTIONS (user 'remote_user', password 'remote_password');

-- 4. å¯¼å…¥å¤–éƒ¨è¡¨åˆ°æœ¬åœ° schema
CREATE SCHEMA IF NOT EXISTS bigdata_web;

IMPORT FOREIGN SCHEMA public
LIMIT TO (t_asset_info, t_ailpha_network_segment, 
          t_ailpha_security_zone, t_vulnerability_info, t_third_auth)
FROM SERVER bigdata_web_server
INTO bigdata_web;
```

**XML ä¿®æ”¹**:
```xml
<!-- ä¿æŒä¸å˜ -->
<select id="querySecurityZone">
    SELECT ti.assetIp, f."name", f.id
    FROM bigdata_web.t_asset_info ti
    JOIN bigdata_web.t_ailpha_network_segment e ON ...
</select>
```

**ä¼˜ç‚¹**:
- âœ… æ”¯æŒçœŸæ­£çš„è·¨æ•°æ®åº“æŸ¥è¯¢
- âœ… XML æ— éœ€ä¿®æ”¹
- âœ… æ•°æ®å®æ—¶åŒæ­¥

**ç¼ºç‚¹**:
- âŒ æ€§èƒ½æ¯” Schema æ–¹å¼ç¨æ…¢
- âŒ ä¸æ”¯æŒå®Œæ•´äº‹åŠ¡ï¼ˆè·¨åº“ï¼‰
- âŒ é…ç½®ç›¸å¯¹å¤æ‚

---

### æ–¹æ¡ˆ3: æ•°æ®è¿ç§»åˆ°åŒä¸€æ•°æ®åº“

**é€‚ç”¨åœºæ™¯**: å¯ä»¥å°†æ‰€æœ‰è¡¨è¿ç§»åˆ°åŒä¸€ä¸ªæ•°æ®åº“

**é…ç½®**:
```sql
-- å°† bigdata_web çš„è¡¨è¿ç§»åˆ°å½“å‰æ•°æ®åº“
-- é€‰é¡¹A: ä½¿ç”¨ schema
CREATE SCHEMA bigdata_web;
-- ç„¶åå¯¼å…¥è¡¨

-- é€‰é¡¹B: ç›´æ¥æ”¾åœ¨ public schema
-- å»æ‰ bigdata_web å‰ç¼€
```

**XML ä¿®æ”¹**:
```xml
<!-- é€‰é¡¹A: ä½¿ç”¨ schemaï¼Œä¿æŒä¸å˜ -->
FROM bigdata_web.t_asset_info ti

<!-- é€‰é¡¹B: å»æ‰å‰ç¼€ -->
FROM t_asset_info ti
```

---

### æ–¹æ¡ˆ4: ä¿®æ”¹ XMLï¼ˆå¦‚æœè¡¨å·²åœ¨å½“å‰åº“ï¼‰

**é€‚ç”¨åœºæ™¯**: è¿™äº›è¡¨å®é™…ä¸Šå·²ç»åœ¨å½“å‰æ•°æ®åº“ä¸­

**XML ä¿®æ”¹**:
```xml
<!-- ä¿®æ”¹å‰ -->
FROM bigdata_web.t_asset_info ti
JOIN bigdata_web.t_ailpha_network_segment e

<!-- ä¿®æ”¹å -->
FROM t_asset_info ti
JOIN t_ailpha_network_segment e
```

---

## ğŸ“‹ è¯¦ç»†é—®é¢˜æ¸…å•

### 1. SecurityZoneSyncMapper.xml

**å½“å‰SQL**:
```xml
<select id="querySecurityZone">
    SELECT ti.assetIp, f."name", f.id
    FROM bigdata_web.t_asset_info ti
    RIGHT JOIN bigdata_web.t_ailpha_network_segment e
    ON e.relation_type='SECURITY_ZONE' AND ti.assetIpNum BETWEEN e.first_ip AND e.last_ip
    LEFT JOIN bigdata_web.t_ailpha_security_zone f ON e.relation_id = f.id
    WHERE f.id is not null
</select>
```

**æ¶‰åŠçš„è¡¨**:
- `bigdata_web.t_asset_info`
- `bigdata_web.t_ailpha_network_segment`
- `bigdata_web.t_ailpha_security_zone`

---

### 2. VulAnalysisSubMapper.xml

**8ä¸ªSQLè¯­å¥**éƒ½åŒ…å«ç±»ä¼¼çš„è·¨åº“æŸ¥è¯¢ï¼š

```xml
LEFT JOIN bigdata_web.t_asset_info ti ON ...
LEFT JOIN bigdata_web.t_ailpha_network_segment e ON ...
LEFT JOIN bigdata_web.t_ailpha_security_zone f ON ...
LEFT JOIN bigdata_web.t_vulnerability_info tf ON ...
```

---

### 3. ThirdAuthMapper.xml

**å½“å‰SQL**:
```xml
<select id="getThirdAuth">
    SELECT auth_tick
    FROM bigdata_web.t_third_auth
    WHERE ...
</select>
```

**æ¶‰åŠçš„è¡¨**:
- `bigdata_web.t_third_auth`

---

## â“ éœ€è¦ç¡®è®¤çš„é—®é¢˜

### è¯·å‘Šè¯‰æˆ‘ä½ çš„å®é™…æƒ…å†µï¼š

1. **æ•°æ®åº“éƒ¨ç½²æ¶æ„**
   - â“ `bigdata_web` æ˜¯ç‹¬ç«‹çš„æ•°æ®åº“å—ï¼Ÿ
   - â“ è¿˜æ˜¯åªæ˜¯ MySQL ä¸­çš„å¦ä¸€ä¸ª databaseï¼ˆPostgreSQL å¯ä»¥ç”¨ schema ä»£æ›¿ï¼‰ï¼Ÿ

2. **è¡¨çš„ä½ç½®**
   - â“ è¿™5ä¸ªè¡¨åœ¨ä½ çš„ PostgreSQL ä¸­å¦‚ä½•éƒ¨ç½²ï¼Ÿ
     - åœ¨åŒä¸€ä¸ªæ•°æ®åº“çš„ä¸åŒ schemaï¼Ÿ
     - åœ¨å®Œå…¨ç‹¬ç«‹çš„æ•°æ®åº“ä¸­ï¼Ÿ
     - è¿˜æ˜¯éƒ½åœ¨ public schemaï¼Ÿ

3. **è¿ç§»ç­–ç•¥**
   - â“ æ˜¯å¦å¯ä»¥å°† `bigdata_web` çš„è¡¨è¿ç§»åˆ°å½“å‰æ•°æ®åº“ï¼Ÿ
   - â“ è¿˜æ˜¯å¿…é¡»ä¿æŒç‹¬ç«‹çš„æ•°æ®åº“ï¼Ÿ

4. **æ€§èƒ½è¦æ±‚**
   - â“ è¿™äº›è·¨åº“æŸ¥è¯¢çš„é¢‘ç‡é«˜å—ï¼Ÿ
   - â“ å¯¹æ€§èƒ½æœ‰ç‰¹æ®Šè¦æ±‚å—ï¼Ÿ

---

## ğŸ¯ æ¨èæ–¹æ¡ˆ

### æ ¹æ®å¸¸è§åœºæ™¯ï¼Œæˆ‘æ¨èï¼š

**å¦‚æœå¯ä»¥è¿ç§»åˆ°åŒä¸€æ•°æ®åº“** â†’ **æ–¹æ¡ˆ1: Schemaæ–¹å¼** â­â­â­â­â­
- æ€§èƒ½æœ€å¥½
- é…ç½®æœ€ç®€å•
- XMLå‡ ä¹æ— éœ€ä¿®æ”¹

**å¦‚æœå¿…é¡»ä¿æŒç‹¬ç«‹æ•°æ®åº“** â†’ **æ–¹æ¡ˆ2: FDWæ–¹å¼** â­â­â­â­
- æ”¯æŒè·¨åº“æŸ¥è¯¢
- XMLæ— éœ€ä¿®æ”¹
- é…ç½®ç¨å¤æ‚

---

## ğŸš€ ä¸‹ä¸€æ­¥æ“ä½œ

### è¯·å‘Šè¯‰æˆ‘ï¼š

1. ä½ çš„å®é™…éƒ¨ç½²æƒ…å†µ
2. é€‰æ‹©å“ªç§æ–¹æ¡ˆ
3. æˆ‘ä¼šä¸ºä½ ç”Ÿæˆå¯¹åº”çš„ä¿®å¤æ–¹æ¡ˆ

---

**æç¤º**: 
- å¦‚æœé€‰æ‹©æ–¹æ¡ˆ1ï¼ˆSchemaï¼‰ï¼ŒXMLå‡ ä¹æ— éœ€ä¿®æ”¹
- å¦‚æœé€‰æ‹©æ–¹æ¡ˆ4ï¼ˆå»æ‰å‰ç¼€ï¼‰ï¼Œæˆ‘éœ€è¦æ‰¹é‡ä¿®æ”¹3ä¸ªXMLæ–‡ä»¶

**ç­‰å¾…ä½ çš„ç¡®è®¤åï¼Œæˆ‘ä¼šç«‹å³æ‰§è¡Œä¿®å¤ï¼**
